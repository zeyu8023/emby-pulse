{% extends "layout.html" %}
{% block title %}映迹工坊 - EmbyPulse{% endblock %}
{% block head %}
<style>
    /* 海报尺寸升级：更宽，更大气 */
    .poster-container { 
        width: 400px; 
        height: 750px; 
        box-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.6); 
        transform-origin: top center; 
        background-color: #111827;
        position: relative;
        overflow: hidden;
    }
    
    /* 玻璃拟态卡片 */
    .glass-panel { 
        background: rgba(255, 255, 255, 0.08); 
        backdrop-filter: blur(16px); 
        border: 1px solid rgba(255, 255, 255, 0.15); 
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .user-option.selected { border-color: #16a34a; background-color: #f0fdf4; }
    
    /* 动态背景图层 */
    #poster-backdrop-layer {
        position: absolute; inset: 0; 
        background-size: cover; background-position: center; 
        filter: blur(20px) brightness(0.6);
        transform: scale(1.1); /* 防止模糊白边 */
        transition: background-image 0.8s ease;
        z-index: 0;
    }
    
    .poster-content { position: relative; z-index: 10; }
</style>
{% endblock %}

{% block content %}
<div class="flex h-full flex-col md:flex-row overflow-hidden">
    
    <div class="w-full md:w-80 bg-white border-r border-gray-200 p-6 flex flex-col z-20 shrink-0 overflow-y-auto">
        <h2 class="text-xl font-black text-gray-800 mb-6 flex items-center">
            <i class="fa-solid fa-paintbrush text-green-600 mr-2"></i> 映迹工坊
        </h2>
        
        <div class="space-y-6 flex-1">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">主角</label>
                <div id="user-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-1">
                    <p class="text-gray-400 text-xs">加载中...</p>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase">年度寄语</label>
                    <button onclick="randomQuote()" class="text-xs text-blue-600 hover:text-blue-800"><i class="fa-solid fa-dice mr-1"></i> 随机灵感</button>
                </div>
                <textarea id="custom-msg" rows="3" class="w-full border-gray-300 rounded-lg text-sm p-3 border focus:ring-green-500 focus:border-green-500 shadow-sm" oninput="document.getElementById('poster-msg').innerText = this.value">生活不仅有代码，还有电影。</textarea>
            </div>
        </div>

        <button onclick="downloadPoster()" id="dl-btn" class="mt-8 w-full py-3 bg-gray-900 hover:bg-black text-white font-bold rounded-xl shadow-xl transition transform active:scale-95 flex justify-center items-center">
            <i class="fa-solid fa-download mr-2"></i> 保存高清海报
        </button>
    </div>

    <div class="flex-1 bg-gray-100 flex justify-center p-8 overflow-y-auto relative" id="preview-wrapper">
        <div id="scale-wrapper" class="mt-4 md:mt-0">
            <div id="capture-area" class="poster-container flex flex-col text-white">
                
                <div id="poster-backdrop-layer"></div>
                <div class="absolute inset-0 z-[1] opacity-20" style="background-image: url('data:image/svg+xml,%3Csvg viewBox=%220 0 200 200%22 xmlns=%22http://www.w3.org/2000/svg%22%3E%3Cfilter id=%22noiseFilter%22%3E%3CfeTurbulence type=%22fractalNoise%22 baseFrequency=%220.65%22 numOctaves=%223%22 stitchTiles=%22stitch%22/%3E%3C/filter%3E%3Crect width=%22100%25%22 height=%22100%25%22 filter=%22url(%23noiseFilter)%22/%3E%3C/svg%3E');"></div>

                <div class="poster-content flex-1 p-8 flex flex-col h-full">
                    
                    <div class="flex justify-between items-start mb-8">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-full border-2 border-white/30 flex items-center justify-center bg-white/10 text-xl font-bold shadow-lg" id="poster-avatar">U</div>
                            <div>
                                <h2 class="text-2xl font-black tracking-tight" id="poster-user">Username</h2>
                                <p class="text-xs text-white/60 font-medium tracking-widest uppercase mt-1">2026 年度观影报告</p>
                            </div>
                        </div>
                        <div class="glass-panel px-3 py-1 rounded-full text-xs font-bold text-yellow-300" id="poster-tag">影视肝帝</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="glass-panel rounded-2xl p-4 text-center">
                            <div class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-white/70" id="poster-hours">0</div>
                            <div class="text-[10px] text-white/50 uppercase font-bold mt-1">总时长 (小时)</div>
                        </div>
                        <div class="glass-panel rounded-2xl p-4 text-center">
                            <div class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white to-white/70" id="poster-plays">0</div>
                            <div class="text-[10px] text-white/50 uppercase font-bold mt-1">播放次数</div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col justify-center mb-6">
                        <div class="text-xs font-bold text-yellow-400 mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-crown"></i> 年度最爱 Top 1
                        </div>
                        <div class="relative w-full aspect-[16/9] rounded-2xl overflow-hidden shadow-2xl border border-white/20 group">
                            <img id="poster-top1-img" src="" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent"></div>
                            <div class="absolute bottom-4 left-4 right-4">
                                <h3 class="text-xl font-bold leading-tight line-clamp-1" id="poster-top1-title">暂无数据</h3>
                                <p class="text-xs text-white/60 mt-1"><span id="poster-top1-plays">0</span> 次播放 · 挚爱之选</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="glass-panel p-3 rounded-xl flex gap-3 items-center">
                            <div class="w-10 h-14 bg-gray-700 rounded overflow-hidden shrink-0"><img id="poster-top2-img" class="w-full h-full object-cover"></div>
                            <div class="min-w-0">
                                <div class="text-[10px] text-white/40 font-bold mb-0.5">Top 2</div>
                                <div class="text-xs font-bold truncate" id="poster-top2-title">-</div>
                            </div>
                        </div>
                        <div class="glass-panel p-3 rounded-xl flex gap-3 items-center">
                            <div class="w-10 h-14 bg-gray-700 rounded overflow-hidden shrink-0"><img id="poster-top3-img" class="w-full h-full object-cover"></div>
                            <div class="min-w-0">
                                <div class="text-[10px] text-white/40 font-bold mb-0.5">Top 3</div>
                                <div class="text-xs font-bold truncate" id="poster-top3-title">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto">
                        <div class="flex justify-between items-end border-t border-white/10 pt-4">
                            <div class="w-2/3 pr-4">
                                <p id="poster-msg" class="text-xs text-white/70 italic leading-relaxed font-light">生活不仅有代码，还有电影。</p>
                                <div class="mt-3 flex items-center gap-2 text-[9px] text-white/40 font-mono">
                                    <span>活跃: <span id="poster-active-hour" class="text-white">--点</span></span>
                                    <span>•</span>
                                    <span>EmbyPulse</span>
                                </div>
                            </div>
                            <div class="w-12 h-12 bg-white p-1 rounded-lg shrink-0 opacity-80">
                                <div class="w-full h-full bg-black flex items-center justify-center text-white text-[8px] font-bold">QR</div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const quotes = ["生活不仅有代码，还有电影。", "有些鸟儿是关不住的。", "能力越大，责任越大。", "愿原力与你同在。", "念念不忘，必有回响。", "我命由我不由天！", "为了看看阳光，我来到这世上。", "风起，唯有努力生存。", "如果不曾见过太阳，我本可以忍受黑暗。", "好的电影，是一次灵魂的洗礼。"];

    function resizePoster() {
        if (window.innerWidth < 1000) {
            const wrapper = document.getElementById('preview-wrapper');
            const scale = (wrapper.clientWidth - 40) / 400;
            const el = document.getElementById('scale-wrapper');
            if (scale < 1) el.style.transform = `scale(${scale})`;
        }
    }
    window.addEventListener('resize', resizePoster);
    setTimeout(resizePoster, 100);

    async function init() { await loadUsers(); }

    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition flex items-center ${index===0?'selected':''}`;
                    div.innerHTML = `<div class="w-6 h-6 rounded-full bg-green-100 text-green-700 text-xs flex items-center justify-center font-bold mr-3">${user.UserName[0].toUpperCase()}</div><span class="text-gray-700 font-medium text-sm">${user.UserName}</span>`;
                    div.onclick = () => selectUser(div, user);
                    container.appendChild(div);
                    if (index === 0) selectUser(div, user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }

    function selectUser(element, user) {
        document.querySelectorAll('.user-option').forEach(el => { el.classList.remove('selected'); el.classList.remove('bg-green-50'); el.classList.remove('border-green-600'); });
        element.classList.add('selected');
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        loadPosterData(user.UserId);
    }

    async function loadPosterData(userId) {
        try {
            const res = await fetch(`/api/stats/poster_data?user_id=${userId}`);
            const json = await res.json();
            
            if(json.status === 'success') {
                const data = json.data;
                
                // 1. 基础数据
                document.getElementById('poster-plays').innerText = data.plays;
                document.getElementById('poster-hours').innerText = data.hours;
                document.getElementById('poster-tag').innerText = data.tags[0] || "观影达人";
                document.getElementById('poster-active-hour').innerText = data.active_hour;

                // 2. Top 1
                if(data.top3 && data.top3.length > 0) {
                    const top1 = data.top3[0];
                    document.getElementById('poster-top1-title').innerText = top1.ItemName;
                    document.getElementById('poster-top1-plays').innerText = top1.P;
                    
                    const imgUrl = `/api/proxy/image/${top1.ItemId}/backdrop`; // 用大图
                    document.getElementById('poster-top1-img').src = imgUrl;
                    document.getElementById('poster-backdrop-layer').style.backgroundImage = `url('${imgUrl}')`;
                }

                // 3. Top 2 & 3
                updateSmallCard(1, data.top3); // Top 2 (index 1)
                updateSmallCard(2, data.top3); // Top 3 (index 2)
            }
        } catch(e) { console.error(e); }
    }

    function updateSmallCard(index, list) {
        const titleEl = document.getElementById(`poster-top${index+1}-title`);
        const imgEl = document.getElementById(`poster-top${index+1}-img`);
        
        if(list && list[index]) {
            titleEl.innerText = list[index].ItemName;
            imgEl.src = `/api/proxy/image/${list[index].ItemId}/primary`; // 用竖图
        } else {
            titleEl.innerText = "-";
            imgEl.src = ""; // 或占位图
        }
    }

    function randomQuote() {
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('custom-msg').value = quote;
        document.getElementById('poster-msg').innerText = quote;
    }

    function downloadPoster() {
        const node = document.getElementById('capture-area');
        const btn = document.getElementById('dl-btn');
        const originalText = btn.innerHTML;
        const userName = document.getElementById('poster-user').innerText;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 生成中...';
        
        html2canvas(node, { scale: 3, useCORS: true, backgroundColor: null }).then(canvas => {
            const link = document.createElement('a');
            link.download = `EmbyReport_2026_${userName}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerHTML = originalText;
        });
    }
    
    init();
</script>
{% endblock %}
