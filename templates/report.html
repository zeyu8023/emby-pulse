{% extends "layout.html" %}
{% block title %}映迹工坊 - 旗舰版{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
    /* 保持 V15 的 CSS 样式，确保流光卡片效果 */
    html, body { height: 100%; margin: 0; background: #e5e5e5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
    .app-container { display: flex; flex-direction: column; height: 100%; }
    .preview-area { flex: 1; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; background-color: #f3f4f6; -webkit-overflow-scrolling: touch; }
    .control-panel { background: white; padding: 20px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 50; flex-shrink: 0; max-height: 40vh; overflow-y: auto; }
    @media (min-width: 768px) { .app-container { flex-direction: row; } .control-panel { width: 360px; height: 100%; max-height: 100%; border-right: 1px solid #ddd; } .preview-area { align-items: center; } }
    
    .poster-canvas { width: 400px; min-height: 750px; height: auto; background: #1a1a1a; position: relative; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.5); color: white; display: flex; flex-direction: column; }
    #poster-bg-img { position: absolute; inset: 0; z-index: 0; background-size: cover; background-position: center; filter: blur(40px) brightness(0.5); transform: scale(1.2); }
    #poster-bg-gradient { position: absolute; inset: 0; z-index: 1; background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.9)); }
    .p-content { position: relative; z-index: 10; padding: 40px 30px; display: flex; flex-direction: column; flex: 1; }
    
    .p-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .user-box { display: flex; align-items: center; gap: 12px; }
    .avatar { width: 56px; height: 56px; border-radius: 50%; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; border: 2px solid rgba(255,255,255,0.3); }
    .user-info h1 { font-size: 26px; font-weight: 900; margin: 0; line-height: 1.2; padding-top: 4px; }
    .user-info p { font-size: 11px; opacity: 0.6; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
    .server-pill { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .server-pill span { display: block; font-weight: 900; font-size: 14px; color: #4ade80; }
    
    .stats-row { display: flex; gap: 15px; margin-bottom: 30px; }
    .stat-card { flex: 1; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .stat-val { font-size: 32px; font-weight: 900; line-height: 1; }
    .stat-label { font-size: 10px; opacity: 0.5; margin-top: 5px; text-transform: uppercase; font-weight: bold; }
    
    .top1-wrapper { width: 100%; aspect-ratio: 16/9; position: relative; border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); }
    .top1-img { width: 100%; height: 100%; background-size: cover; background-position: center; }
    .top1-mask { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
    .top1-info { position: absolute; bottom: 15px; left: 15px; right: 15px; }
    .top1-badge { display: inline-block; background: #eab308; color: black; font-size: 10px; font-weight: 900; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }
    .top1-title { font-size: 20px; font-weight: bold; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .rank-list { display: flex; flex-direction: column; gap: 10px; }
    .rank-row { display: flex; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 10px; }
    .rank-idx { font-size: 14px; font-weight: 900; color: rgba(255,255,255,0.3); width: 25px; }
    .rank-name { flex: 1; font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; }
    .rank-count { font-size: 11px; opacity: 0.6; }
    
    .p-footer { margin-top: auto; padding-top: 30px; text-align: center; opacity: 0.4; font-size: 10px; letter-spacing: 2px; }
    .empty-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.3; min-height: 300px; }
    .btn-group { display: flex; gap: 8px; margin-bottom: 15px; }
    .btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; font-weight: bold; border-radius: 8px; font-size: 12px; cursor: pointer; }
    .btn.active { background: #111827; color: white; border-color: #111827; }
</style>
{% endblock %}

{% block content %}
<div class="app-container">
    <div class="preview-area">
        <div id="scale-wrapper">
            <div id="capture-target" class="poster-canvas">
                <div id="poster-bg-img"></div>
                <div id="poster-bg-gradient"></div>
                
                <div class="p-content">
                    <div class="p-header">
                        <div class="user-box">
                            <div class="avatar" id="p-avatar">U</div>
                            <div class="user-info">
                                <h1 id="p-user">User</h1>
                                <p id="p-period">2026 年度报告</p>
                            </div>
                        </div>
                        <div class="server-pill">
                            <span id="p-server">0</span>
                            全服总播
                        </div>
                    </div>

                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-val" id="p-hours">0</div>
                            <div class="stat-label">专注时长 (H)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val" id="p-plays">0</div>
                            <div class="stat-label">播放次数</div>
                        </div>
                    </div>

                    <div id="content-area">
                        <div id="top1-wrapper" class="top1-wrapper" style="display:none;">
                            <div id="top1-img" class="top1-img"></div>
                            <div class="top1-mask"></div>
                            <div class="top1-info">
                                <div class="top1-badge">TOP 1 年度最爱</div>
                                <div class="top1-title" id="top1-title">-</div>
                                <div style="font-size: 11px; opacity: 0.7; margin-top: 2px;" id="top1-count">0 次播放</div>
                            </div>
                        </div>
                        <div class="rank-list" id="rank-list"></div>
                    </div>

                    <div id="empty-area" class="empty-box" style="display:none;">
                        <i class="fa-solid fa-moon" style="font-size: 40px; margin-bottom: 10px;"></i>
                        <p>该时段暂无记录</p>
                    </div>

                    <div class="p-footer">GENERATED BY EMBY PULSE</div>
                </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <label style="font-size: 12px; font-weight: bold; color: #666;">用户</label>
        <select id="user-select" onchange="changeUser(this.value)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; margin-top: 5px;">
            <option>Loading...</option>
        </select>

        <label style="font-size: 12px; font-weight: bold; color: #666;">时间</label>
        <div class="btn-group" style="margin-top: 5px;">
            <button class="btn" onclick="setPeriod('all', this)">全量</button>
            <button class="btn" onclick="setPeriod('year', this)">年度</button>
            <button class="btn active" onclick="setPeriod('month', this)">本月</button>
            <button class="btn" onclick="setPeriod('week', this)">本周</button>
        </div>

        <button onclick="savePoster()" style="width: 100%; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 14px; margin-top: 10px;">
            保存海报
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let currentUserId = '';
    let currentPeriod = 'month';

    function fitScale() {
        const wrapper = document.querySelector('.preview-area');
        const scale = Math.min((wrapper.clientWidth - 40) / 400, 1);
        document.getElementById('scale-wrapper').style.transform = `scale(${scale})`;
        document.getElementById('scale-wrapper').style.transformOrigin = 'top center';
    }
    window.addEventListener('resize', fitScale);
    setTimeout(fitScale, 100);

    async function init() {
        const res = await fetch('/api/users');
        const json = await res.json();
        const sel = document.getElementById('user-select');
        sel.innerHTML = '';
        if(json.data && json.data.length > 0) {
            json.data.forEach((u, index) => {
                const opt = document.createElement('option');
                opt.value = u.UserId;
                opt.innerText = u.UserName;
                sel.appendChild(opt);
            });
            changeUser(json.data[0].UserId);
        }
    }

    function changeUser(uid) {
        currentUserId = uid;
        const sel = document.getElementById('user-select');
        document.getElementById('p-user').innerText = sel.options[sel.selectedIndex].text;
        document.getElementById('p-avatar').innerText = sel.options[sel.selectedIndex].text[0].toUpperCase();
        loadData();
    }

    function setPeriod(p, btn) {
        currentPeriod = p;
        document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const map = {'all':'全量报告','year':'年度报告','month':'本月报告','week':'本周报告'};
        document.getElementById('p-period').innerText = map[p];
        loadData();
    }

    async function loadData() {
        if(!currentUserId) return;
        const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
        const json = await res.json();
        const data = json.data;

        document.getElementById('p-plays').innerText = data.plays;
        document.getElementById('p-hours').innerText = data.hours;
        document.getElementById('p-server').innerText = data.server_plays;

        const hasData = data.plays > 0;
        document.getElementById('content-area').style.display = hasData ? 'block' : 'none';
        document.getElementById('empty-area').style.display = hasData ? 'none' : 'flex';

        if(hasData) {
            const list = data.top_list;
            // Top 1
            if(list[0]) {
                document.getElementById('top1-wrapper').style.display = 'block';
                document.getElementById('top1-title').innerText = list[0].ItemName;
                document.getElementById('top1-count').innerText = `${list[0].Count} 次播放`;
                const img = new Image();
                img.src = `/api/proxy/image/${list[0].ItemId}/backdrop`;
                img.onload = () => { 
                    document.getElementById('top1-img').style.backgroundImage = `url('${img.src}')`; 
                    document.getElementById('poster-bg-img').style.backgroundImage = `url('${img.src}')`;
                };
                img.onerror = () => {
                    const fallback = 'https://via.placeholder.com/400x225/333/666?text=No+Image';
                    document.getElementById('top1-img').style.backgroundImage = `url('${fallback}')`;
                    document.getElementById('poster-bg-img').style.backgroundImage = `url('${fallback}')`;
                }
            } else {
                document.getElementById('top1-wrapper').style.display = 'none';
            }

            // List
            const listEl = document.getElementById('rank-list');
            let html = '';
            const max = Math.min(list.length, 10);
            for(let i=1; i<max; i++) {
                html += `
                <div class="rank-row">
                    <div class="rank-idx">${i+1}</div>
                    <div class="rank-name">${list[i].ItemName}</div>
                    <div class="rank-count">${list[i].Count}次</div>
                </div>`;
            }
            listEl.innerHTML = html;
        }
    }

    async function savePoster() {
        const node = document.getElementById('capture-target');
        const wrapper = document.getElementById('scale-wrapper');
        const oldT = wrapper.style.transform;
        wrapper.style.transform = 'none';
        await new Promise(r => setTimeout(r, 100));
        
        try {
            const canvas = await html2canvas(node, { scale: 2, useCORS: true, backgroundColor: '#1a1a1a' });
            const link = document.createElement('a');
            link.download = `EmbyReport_${currentUserId}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch(e) { alert('生成失败'); console.error(e); }
        finally { wrapper.style.transform = oldT; }
    }

    init();
</script>
{% endblock %}