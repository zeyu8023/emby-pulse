{% extends "layout.html" %}
{% block title %}æ˜ è¿¹å·¥åŠ - EmbyPulse{% endblock %}
{% block head %}
<style>
    /* ================= æ ¸å¿ƒå®¹å™¨ï¼šå›ºå®šæ­»å°ºå¯¸ ================= */
    /* è¿™é‡Œçš„å°ºå¯¸ç»å¯¹ä¸èƒ½ç”¨ç™¾åˆ†æ¯”æˆ–è€…è‡ªé€‚åº” */
    .poster-wrapper-fixed {
        width: 400px;
        height: 750px;
        flex-shrink: 0;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        border-radius: 16px;
        overflow: hidden;
        position: relative;
        background-color: #111827; /* å¼ºåˆ¶æ·±è‰²åº•ï¼Œé˜²æ­¢é€æ˜bug */
    }

    /* ================= ä¸‡èƒ½èƒŒæ™¯å›¾ç»„ä»¶ (è§£å†³æ‹‰ä¼¸é—®é¢˜çš„æ ¸å¿ƒ) ================= */
    /* æ‰€æœ‰çš„å›¾ç‰‡(èƒŒæ™¯ã€Top123)éƒ½å¿…é¡»ç”¨è¿™ä¸ª class */
    .bg-image-cover {
        position: absolute; inset: 0;
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
        transition: background-image 0.3s ease;
    }

    /* ä¸“é—¨ç”¨äºä¸»èƒŒæ™¯çš„æ ·å¼ï¼Œé¢„è§ˆæ—¶å¸¦æ»¤é•œ */
    #main-backdrop {
        z-index: 0;
        /* é¢„è§ˆæ—¶çš„ CSS æ»¤é•œ (ä¸‹è½½æ—¶ä¼šè¢« JS ç‰©ç†æ¨¡ç³Šæ›¿ä»£) */
        filter: blur(16px) brightness(0.6); 
        transform: scale(1.1); /* æ”¾å¤§é˜²æ­¢ç™½è¾¹ */
    }

    /* çº¯è‰²æ¸å˜èƒŒæ™¯å±‚ */
    #main-gradient { z-index: 0; transition: background 0.3s ease; }

    /* å†…å®¹å±‚ */
    .poster-content-layer {
        position: relative; z-index: 10;
        height: 100%; display: flex; flex-direction: column;
        padding: 32px; /* ç»Ÿä¸€å¤§å†…è¾¹è·ï¼Œé˜²æ­¢æ–‡å­—è´´è¾¹ */
    }

    /* ================= ç»ç’ƒå¡ç‰‡ (ç¨³å®šç‰ˆ) ================= */
    .glass-panel { 
        background: rgba(0, 0, 0, 0.5); /* çº¯åŠé€æ˜é»‘ï¼Œæ”¾å¼ƒ backdrop-filter */
        border: 1px solid rgba(255, 255, 255, 0.15); 
        border-radius: 12px;
    }
    
    /* ================= å¸ƒå±€è¾…åŠ©ç±» (è§£å†³æ–‡å­—æˆªæ–­) ================= */
    /* å¼ºåˆ¶æ–‡å­—å®¹å™¨å…·æœ‰å¼¹æ€§ï¼Œä¸”å…è®¸å‹ç¼©åˆ°0 */
    .flex-truncate-box { flex: 1; min-width: 0; }
    /* å¼ºåˆ¶æ–‡å­—å•è¡Œçœç•¥ */
    .text-ellipsis-single { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* å¼ºåˆ¶æ–‡å­—ä¸¤è¡Œçœç•¥ */
    .text-ellipsis-double {
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        white-space: normal; /* å…è®¸æ¢è¡Œ */
    }

    /* ================= äº¤äº’ç»„ä»¶æ ·å¼ ================= */
    .user-option.selected { border-color: #16a34a; background-color: #f0fdf4; }
    .bg-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .bg-option:hover { transform: scale(1.2); }
    .bg-option.active { border-color: #16a34a; transform: scale(1.1); }
    
    /* é¢„è§ˆåŒºåŸŸå±…ä¸­ */
    #preview-stage {
        flex: 1; background-color: #f3f4f6;
        display: flex; justify-content: center; align-items: flex-start;
        padding: 30px 20px; overflow: auto;
    }
    /* ç¼©æ”¾æ§åˆ¶å™¨ */
    #scaler { transform-origin: top center; transition: transform 0.3s ease; }
</style>
{% endblock %}

{% block content %}
<div class="flex h-full flex-col md:flex-row overflow-hidden">
    
    <div class="w-full md:w-80 bg-white border-r border-gray-200 p-6 flex flex-col z-20 shrink-0 overflow-y-auto shadow-[4px_0_15px_rgba(0,0,0,0.05)] relative">
        <h2 class="text-xl font-black text-gray-800 mb-6 flex items-center">
            <i class="fa-solid fa-paintbrush text-green-600 mr-2"></i> æ˜ è¿¹å·¥åŠ
        </h2>
        
        <div class="space-y-6 flex-1">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä¸»è§’</label>
                <div id="user-list-container" class="space-y-2 max-h-48 overflow-y-auto pr-1 custom-scrollbar">
                    <p class="text-gray-400 text-xs py-2">åŠ è½½ç”¨æˆ·åˆ—è¡¨...</p>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ—¶é—´èŒƒå›´</label>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setPeriod('all')" class="period-btn bg-gray-900 text-white text-xs py-2 rounded-lg font-bold transition-all" data-p="all">å…¨é‡</button>
                    <button onclick="setPeriod('year')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition-all" data-p="year">å¹´åº¦</button>
                    <button onclick="setPeriod('month')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition-all" data-p="month">æœ¬æœˆ</button>
                    <button onclick="setPeriod('week')" class="period-btn bg-gray-100 text-gray-500 text-xs py-2 rounded-lg font-bold hover:bg-gray-200 transition-all" data-p="week">æœ¬å‘¨</button>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æ°›å›´è®¾å®š</label>
                <div class="flex flex-wrap gap-3">
                    <div class="bg-option active flex items-center justify-center bg-gray-800 text-white text-[8px] font-bold" onclick="setBg('auto', this)" title="ä½¿ç”¨ Top1 å½±ç‰‡èƒŒæ™¯">AUTO</div>
                    <div class="bg-option" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%)" onclick="setBg('linear-gradient(135deg, #1f2937 0%, #111827 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(to top, #30cfd0 0%, #330867 100%)" onclick="setBg('linear-gradient(to top, #30cfd0 0%, #330867 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(to top, #5f72bd 0%, #9b23ea 100%)" onclick="setBg('linear-gradient(to top, #5f72bd 0%, #9b23ea 100%)', this)"></div>
                    <div class="bg-option" style="background: linear-gradient(to right, #fa709a 0%, #fee140 100%)" onclick="setBg('linear-gradient(to right, #fa709a 0%, #fee140 100%)', this)"></div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase">å¯„è¯­</label>
                    <button onclick="randomQuote()" class="text-xs text-blue-600 hover:text-blue-800 transition-colors"><i class="fa-solid fa-dice mr-1"></i> éšæœºçµæ„Ÿ</button>
                </div>
                <textarea id="custom-msg" rows="3" class="w-full border-gray-300 rounded-lg text-sm p-3 border focus:ring-green-500 focus:border-green-500 shadow-sm transition-shadow resize-none font-light" oninput="document.getElementById('poster-msg').innerText = this.value">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</textarea>
            </div>
        </div>

        <div class="mt-8 space-y-3">
            <button onclick="processCapture('download')" id="dl-btn" class="w-full py-3.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl shadow-lg transition transform active:scale-[0.98] flex justify-center items-center text-sm">
                <i class="fa-solid fa-download mr-2 text-lg"></i> ä¿å­˜é«˜æ¸…æµ·æŠ¥
            </button>
            <button onclick="processCapture('copy')" id="cp-btn" class="w-full py-3.5 bg-white border-2 border-gray-200 hover:border-gray-300 text-gray-700 font-bold rounded-xl shadow-sm transition transform active:scale-[0.98] flex justify-center items-center text-sm">
                <i class="fa-regular fa-copy mr-2 text-lg"></i> å¤åˆ¶åˆ°å‰ªè´´æ¿
            </button>
        </div>
    </div>

    <div id="preview-stage">
        <div id="scaler">
            
            <div id="capture-target" class="poster-wrapper-fixed">
                
                <div id="main-backdrop" class="bg-image-cover" style="display: none;"></div>
                <div id="main-gradient" class="absolute inset-0" style="display: none;"></div>
                
                <div class="absolute inset-0 z-[1] opacity-20" style="background-image: url('https://www.transparenttextures.com/patterns/stardust.png'); pointer-events: none; mix-blend-mode: overlay;"></div>

                <div class="poster-content-layer">
                    
                    <div class="flex justify-between items-start mb-10">
                        <div class="flex items-center gap-4 flex-truncate-box mr-4">
                            <div class="w-16 h-16 rounded-full border-[3px] border-white/20 flex items-center justify-center bg-white/10 text-2xl font-black shadow-xl shrink-0 text-white" id="poster-avatar">U</div>
                            <div class="flex-truncate-box">
                                <h2 class="text-3xl font-black tracking-tight text-white text-ellipsis-single" id="poster-user">Username</h2>
                                <p class="text-xs text-white/70 font-bold tracking-[0.2em] uppercase mt-1 text-ellipsis-single" id="poster-period-text">å…¨é‡è§‚å½±æŠ¥å‘Š</p>
                            </div>
                        </div>
                        <div class="glass-panel px-4 py-1.5 rounded-full text-xs font-black text-yellow-300 shadow-lg shrink-0 flex items-center uppercase tracking-wider">
                            <i class="fa-solid fa-medal mr-2"></i><span id="poster-tag">è§‚å½±è¾¾äºº</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5 mb-10 shrink-0">
                        <div class="glass-panel rounded-3xl py-6 px-4 text-center flex flex-col justify-center">
                            <div class="text-5xl font-black text-white leading-none mb-2 tracking-tighter" id="poster-hours">0</div>
                            <div class="text-xs text-white/60 font-bold uppercase tracking-widest">æ€»æ—¶é•¿ (å°æ—¶)</div>
                        </div>
                        <div class="glass-panel rounded-3xl py-6 px-4 text-center flex flex-col justify-center">
                            <div class="text-5xl font-black text-white leading-none mb-2 tracking-tighter" id="poster-plays">0</div>
                            <div class="text-xs text-white/60 font-bold uppercase tracking-widest">æ’­æ”¾æ¬¡æ•°</div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col justify-center mb-8 min-h-0">
                        <div class="text-sm font-black text-yellow-400 mb-4 flex items-center gap-2 shrink-0 uppercase tracking-wider">
                            <i class="fa-solid fa-crown text-lg"></i> å¹´åº¦æœ€çˆ± Top 1
                        </div>
                        <div class="relative w-full aspect-[16/9] rounded-3xl overflow-hidden shadow-2xl border border-white/10 group bg-black/30 flex-shrink-0">
                            <div id="top1-bg" class="bg-image-cover" style="background-image: url('https://via.placeholder.com/800x450/374151/9ca3af?text=No+Data');"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/50 to-transparent z-10"></div>
                            <div class="absolute bottom-6 left-6 right-6 z-20">
                                <h3 class="text-2xl font-bold leading-tight text-white text-ellipsis-double" id="poster-top1-title">æš‚æ— æ•°æ®</h3>
                                <p class="text-sm font-medium text-white/80 mt-2 text-ellipsis-single"><i class="fa-solid fa-play-circle mr-1.5 opacity-70"></i> <span id="poster-top1-plays" class="font-bold text-white">0</span> æ¬¡æ’­æ”¾ Â· æŒšçˆ±ä¹‹é€‰</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-5 mb-10 shrink-0">
                        <div class="glass-panel p-3 rounded-2xl flex gap-4 items-center overflow-hidden">
                            <div id="top2-bg" class="w-12 h-16 bg-gray-800 rounded-lg overflow-hidden shrink-0 bg-image-cover shadow-md" style="background-image: url('https://via.placeholder.com/100x150/374151/9ca3af?text=No');"></div>
                            <div class="flex-truncate-box">
                                <div class="text-[10px] text-white/50 font-bold mb-0.5 uppercase tracking-wider">Top 2</div>
                                <div class="text-sm font-bold text-white text-ellipsis-single leading-tight" id="poster-top2-title">-</div>
                            </div>
                        </div>
                        <div class="glass-panel p-3 rounded-2xl flex gap-4 items-center overflow-hidden">
                            <div id="top3-bg" class="w-12 h-16 bg-gray-800 rounded-lg overflow-hidden shrink-0 bg-image-cover shadow-md" style="background-image: url('https://via.placeholder.com/100x150/374151/9ca3af?text=No');"></div>
                            <div class="flex-truncate-box">
                                <div class="text-[10px] text-white/50 font-bold mb-0.5 uppercase tracking-wider">Top 3</div>
                                <div class="text-sm font-bold text-white text-ellipsis-single leading-tight" id="poster-top3-title">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto shrink-0">
                        <div class="border-t border-white/15 pt-6">
                            <i class="fa-solid fa-quote-left text-white/30 text-xl mb-2 block"></i>
                            <p id="poster-msg" class="text-sm text-white/90 italic leading-relaxed font-light text-ellipsis-double">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</p>
                            <div class="mt-6 flex items-center justify-between opacity-60">
                                 <div class="flex items-center gap-2 text-[10px] text-white font-mono uppercase tracking-widest">
                                    <i class="fa-solid fa-film text-green-500"></i>
                                    <span>EmbyPulse Â· æ˜ è¿¹</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    const quotes = ["ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚", "æœ‰äº›é¸Ÿå„¿æ˜¯å…³ä¸ä½çš„ã€‚", "èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚", "æ„¿åŸåŠ›ä¸ä½ åŒåœ¨ã€‚", "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›å“ã€‚", "æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©ï¼", "ä¸ºäº†çœ‹çœ‹é˜³å…‰ï¼Œæˆ‘æ¥åˆ°è¿™ä¸–ä¸Šã€‚", "é£èµ·ï¼Œå”¯æœ‰åŠªåŠ›ç”Ÿå­˜ã€‚", "å¦‚æœä¸æ›¾è§è¿‡å¤ªé˜³ï¼Œæˆ‘æœ¬å¯ä»¥å¿å—é»‘æš—ã€‚", "å¥½çš„ç”µå½±ï¼Œæ˜¯ä¸€æ¬¡çµé­‚çš„æ´—ç¤¼ã€‚", "æ— è®ºæœ€ç»ˆç»“æœå°†äººç±»å†å²å¯¼å‘ä½•å¤„ï¼Œæˆ‘ä»¬å†³å®šï¼Œé€‰æ‹©å¸Œæœ›ã€‚", "ä¸è¦æ¸©å’Œåœ°èµ°è¿›é‚£ä¸ªè‰¯å¤œã€‚"];
    let currentPeriod = 'all';
    let currentUserId = '';
    let currentTop1BackdropUrl = '';
    let isAutoBg = true;

    // å±å¹•é€‚é…ç¼©æ”¾ (ä»…ç”¨äºé¢„è§ˆå±•ç¤ºï¼Œæˆªå›¾æ—¶ä¸ä¾èµ–æ­¤)
    function fitPreviewToScreen() {
        const stage = document.getElementById('preview-stage');
        const scaler = document.getElementById('scaler');
        const wrapper = document.getElementById('capture-target');
        
        // è®¡ç®—å¯ç”¨å®½åº¦å’Œé«˜åº¦ï¼Œé¢„ç•™è¾¹è·
        const availableWidth = stage.clientWidth - 40; 
        const availableHeight = stage.clientHeight - 60;
        
        // è®¡ç®—å®½å’Œé«˜çš„ç¼©æ”¾æ¯”ä¾‹
        const scaleX = availableWidth / wrapper.offsetWidth;
        const scaleY = availableHeight / wrapper.offsetHeight;
        
        // å–è¾ƒå°å€¼ä»¥ç¡®ä¿å®Œå…¨æ˜¾ç¤ºï¼Œä¸”ä¸è¶…è¿‡1å€
        let finalScale = Math.min(scaleX, scaleY, 1);
        // é˜²æ­¢ç¼©æ”¾è¿‡å°
        if (finalScale < 0.5) finalScale = 0.5;

        scaler.style.transform = `scale(${finalScale})`;
    }
    // ç›‘å¬çª—å£å˜åŒ–å’ŒåŠ è½½å®Œæˆ
    window.addEventListener('resize', fitPreviewToScreen);
    window.addEventListener('load', fitPreviewToScreen);
    // æ•°æ®åŠ è½½åä¹Ÿéœ€è¦é‡æ–°è®¡ç®—ï¼Œç»™ç‚¹å»¶è¿Ÿç¡®ä¿DOMæ¸²æŸ“å®Œæ¯•
    const triggerResize = () => setTimeout(fitPreviewToScreen, 200);


    // ğŸ”¥ æ ¸å¿ƒå·¥å…·ï¼šè®¾ç½® DIV èƒŒæ™¯å›¾çš„é€šç”¨å‡½æ•° (å¸¦å›é€€é€»è¾‘)
    function setDivBg(elementId, url, isTop1 = false) {
        const el = document.getElementById(elementId);
        if (!el) return;
        
        const img = new Image();
        img.onload = () => { 
            el.style.backgroundImage = `url('${url}')`; 
            if(isTop1) triggerResize(); // å›¾ç‰‡åŠ è½½å¯èƒ½æ”¹å˜å¸ƒå±€ï¼Œè§¦å‘é‡ç®—
        };
        img.onerror = () => {
            console.warn(`Image failed to load: ${url}`);
            // Top1 å¤§å›¾å›é€€é€»è¾‘
            if (isTop1 && url.includes('backdrop')) {
                 console.log('Switching Top1 to primary image...');
                 const newUrl = url.replace('backdrop', 'primary');
                 // æ›´æ–°è®°å½•çš„ URLï¼Œç¡®ä¿ AutoBG ç”¨å¯¹çš„å›¾
                 currentTop1BackdropUrl = newUrl; 
                 setDivBg(elementId, newUrl, true);
                 if (isAutoBg) setBg('auto', document.querySelector('.bg-option.active'));
            } else {
                 // å…¶ä»–å°å›¾æˆ–äºŒæ¬¡å¤±è´¥ï¼Œç”¨å ä½å›¾
                 el.style.backgroundImage = `url('https://via.placeholder.com/400x225/1f2937/4b5563?text=N/A')`;
            }
        };
        // å¼€å§‹åŠ è½½
        img.src = url;
    }

    async function init() { await loadUsers(); triggerResize(); }

    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition flex items-center ${index===0?'selected':''}`;
                    div.innerHTML = `<div class="w-6 h-6 rounded-full bg-green-100 text-green-700 text-xs flex items-center justify-center font-bold mr-3 shrink-0">${user.UserName[0].toUpperCase()}</div><span class="text-gray-700 font-medium text-sm text-ellipsis-single flex-1">${user.UserName}</span>`;
                    div.onclick = () => selectUser(div, user);
                    container.appendChild(div);
                    if (index === 0) selectUser(div, user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }

    function selectUser(element, user) {
        document.querySelectorAll('.user-option').forEach(el => { el.classList.remove('selected'); el.classList.remove('bg-green-50'); el.classList.remove('border-green-600'); });
        element.classList.add('selected');
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        currentUserId = user.UserId;
        loadPosterData();
    }

    function setPeriod(period) {
        currentPeriod = period;
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.classList.toggle('bg-gray-900', btn.dataset.p === period);
            btn.classList.toggle('text-white', btn.dataset.p === period);
            btn.classList.toggle('bg-gray-100', btn.dataset.p !== period);
            btn.classList.toggle('text-gray-500', btn.dataset.p !== period);
        });
        const periodTextMap = {'all': 'å…¨é‡è§‚å½±æŠ¥å‘Š', 'year': 'å¹´åº¦è§‚å½±æŠ¥å‘Š', 'month': 'æœ¬æœˆè§‚å½±æŠ¥å‘Š', 'week': 'æœ¬å‘¨è§‚å½±æŠ¥å‘Š'};
        document.getElementById('poster-period-text').innerText = periodTextMap[period];
        loadPosterData();
    }

    async function loadPosterData() {
        if(!currentUserId) return;
        try {
            const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
            const json = await res.json();
            if(json.status === 'success') {
                const data = json.data;
                document.getElementById('poster-plays').innerText = data.plays;
                document.getElementById('poster-hours').innerText = data.hours;
                document.getElementById('poster-tag').innerText = data.tags[0] || "è§‚å½±è¾¾äºº";

                if(data.top3 && data.top3.length > 0) {
                    const top1 = data.top3[0];
                    document.getElementById('poster-top1-title').innerText = top1.ItemName;
                    document.getElementById('poster-top1-plays').innerText = top1.P;
                    
                    // ä¼˜å…ˆç”¨ Backdropï¼ŒSetDivBg ä¼šå¤„ç†å›é€€
                    const imgUrl = `/api/proxy/image/${top1.ItemId}/backdrop`; 
                    currentTop1BackdropUrl = imgUrl;
                    setDivBg('top1-bg', imgUrl, true);
                    
                    if(isAutoBg) updateBgImage(imgUrl);
                } else {
                    resetTop1Data();
                }
                updateSmallCards(data.top3);
                triggerResize();
            }
        } catch(e) { console.error(e); }
    }

    function resetTop1Data() {
        document.getElementById('poster-top1-title').innerText = "æš‚æ— æ•°æ®";
        document.getElementById('poster-top1-plays').innerText = "0";
        setDivBg('top1-bg', 'https://via.placeholder.com/800x450/1f2937/4b5563?text=No+Data');
        currentTop1BackdropUrl = '';
        if(isAutoBg) updateBgImage('');
    }

    function updateSmallCards(list) {
        const updateCard = (idx) => {
             const titleEl = document.getElementById(`poster-top${idx}-title`);
             const bgId = `top${idx}-bg`;
             if(list && list[idx-1]) {
                 titleEl.innerText = list[idx-1].ItemName;
                 setDivBg(bgId, `/api/proxy/image/${list[idx-1].ItemId}/primary`);
             } else {
                 titleEl.innerText = "-";
                 setDivBg(bgId, 'https://via.placeholder.com/100x150/1f2937/4b5563?text=N/A');
             }
        }
        updateCard(2);
        updateCard(3);
    }

    function updateBgImage(src) {
        const bgLayer = document.getElementById('main-backdrop');
        const bgGrad = document.getElementById('main-gradient');
        bgGrad.style.display = 'none';
        bgLayer.style.display = 'block';
        if(src) {
             setDivBg('main-backdrop', src);
        } else {
            // æ²¡æœ‰ Top1 æ—¶çš„é»˜è®¤èƒŒæ™¯
             bgLayer.style.backgroundImage = 'linear-gradient(135deg, #111827 0%, #1f2937 100%)';
        }
    }

    function setBg(val, el) {
        document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
        const bgLayer = document.getElementById('main-backdrop');
        const bgGrad = document.getElementById('main-gradient');
        
        if(val === 'auto') {
            isAutoBg = true;
            updateBgImage(currentTop1BackdropUrl);
        } else {
            isAutoBg = false;
            bgLayer.style.display = 'none';
            bgGrad.style.display = 'block';
            bgGrad.style.background = val;
        }
        triggerResize();
    }

    function randomQuote() {
        const quote = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById('custom-msg').value = quote;
        document.getElementById('poster-msg').innerText = quote;
    }

    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šç‰©ç†é«˜æ–¯æ¨¡ç³Š (JS Canvas å®ç°) - è§£å†³æˆªå›¾æ— æ¨¡ç³Šé—®é¢˜
    async function applyPhysicalBlur() {
        const bgLayer = document.getElementById('main-backdrop');
        // å¦‚æœæ²¡æ˜¾ç¤ºæˆ–ä¸æ˜¯å›¾ç‰‡èƒŒæ™¯ï¼Œè·³è¿‡
        if (bgLayer.style.display === 'none' || !bgLayer.style.backgroundImage.includes('url')) return null;

        const bgImageStyle = bgLayer.style.backgroundImage;
        // æå–å¹²å‡€çš„ URL (ç§»é™¤ url("") åŒ…è£¹)
        const urlMatch = bgImageStyle.match(/url\(['"]?(.*?)['"]?\)/);
        if (!urlMatch || !urlMatch[1]) return null;
        const imgUrl = urlMatch[1];

        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "Anonymous"; // å…³é”®ï¼šå…è®¸è·¨åŸŸæ“ä½œ
            
            img.onload = () => {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    // æåº¦ç¼©å°å°ºå¯¸ (æ¯”å¦‚åŸå›¾çš„ 3%) åˆ¶é€ é©¬èµ›å…‹æ¨¡ç³Š
                    const w = Math.max(img.naturalWidth * 0.03, 20); 
                    const h = Math.max(img.naturalHeight * 0.03, 20);
                    canvas.width = w;
                    canvas.height = h;
                    // ç»˜åˆ¶å¾®ç¼©å›¾
                    ctx.drawImage(img, 0, 0, w, h);
                    // è·å–å¾®ç¼©å›¾çš„ Base64
                    const blurredDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // ä¿å­˜åŸå§‹çŠ¶æ€
                    const originalFilter = bgLayer.style.filter;
                    // æ›¿æ¢èƒŒæ™¯ä¸ºæ¨¡ç³Šåçš„å›¾
                    bgLayer.style.backgroundImage = `url(${blurredDataUrl})`;
                    // ç§»é™¤ CSS æ¨¡ç³Šæ»¤é•œï¼Œåªä¿ç•™äº®åº¦å‹æš—ï¼Œé˜²æ­¢åŒé‡æ¨¡ç³Š
                    bgLayer.style.filter = 'brightness(0.6)'; 
                    
                    console.log('Physical blur applied successfully.');
                    // è¿”å›æ¢å¤å‡½æ•°
                    resolve(() => {
                        bgLayer.style.backgroundImage = bgImageStyle;
                        bgLayer.style.filter = originalFilter;
                    });
                } catch (err) {
                    console.warn("Canvas blur failed (likely CORS), skipping blur.", err);
                    resolve(null);
                }
            };
            // å›¾ç‰‡åŠ è½½å¤±è´¥æˆ–è·¨åŸŸæŠ¥é”™ï¼Œæ”¾å¼ƒæ¨¡ç³Šï¼Œç›´æ¥æˆªå›¾
            img.onerror = (e) => {
                console.warn("Background image load failed for blur.", e);
                resolve(null);
            };
            // å¼€å§‹åŠ è½½
            img.src = imgUrl;
        });
    }

    async function processCapture(action) {
        const targetNode = document.getElementById('capture-target');
        const scaler = document.getElementById('scaler');
        const btn = document.getElementById(action === 'download' ? 'dl-btn' : 'cp-btn');
        const originalText = btn.innerHTML;
        
        // 1. UI çŠ¶æ€æ›´æ–°
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> å¤„ç†ä¸­...';
        btn.disabled = true;
        document.body.style.cursor = 'wait';

        // 2. æš‚åœé¢„è§ˆç¼©æ”¾ï¼Œç¡®ä¿æˆªå›¾å°ºå¯¸ä¸ºåŸå§‹çš„ 400x750
        const currentTransform = scaler.style.transform;
        scaler.style.transform = 'none';
        // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜
        scaler.offsetHeight; 

        // 3. åº”ç”¨ç‰©ç†æ¨¡ç³Š (å¼‚æ­¥ç­‰å¾…å®Œæˆ)
        const restoreBgFn = await applyPhysicalBlur();
        // å†æ¬¡å¼ºåˆ¶é‡ç»˜ï¼Œç¡®ä¿æ¨¡ç³Šç”Ÿæ•ˆ
        targetNode.offsetHeight;

        try {
            // 4. å¼€å§‹æˆªå›¾
            console.log('Starting html2canvas capture...');
            const canvas = await html2canvas(targetNode, {
                scale: 3, // 3å€è¶…æ¸…
                useCORS: true, 
                backgroundColor: '#111827', // ç¡®ä¿åº•è‰²æ­£ç¡®
                allowTaint: false, // ä¸¥æ ¼æ¨¡å¼ï¼Œé˜²æ­¢æ±¡æŸ“
                logging: false,
                // æ˜ç¡®æŒ‡å®šæˆªå›¾å°ºå¯¸å’Œä½ç½®ï¼Œé˜²æ­¢åç§»
                width: 400, height: 750, x: 0, y: 0,
                scrollX: 0, scrollY: 0,
                onclone: (clonedDoc) => {
                    // åœ¨å…‹éš†ä½“ä¸­å†æ¬¡ç¡®ä¿æ—  transform
                    const clonedScaler = clonedDoc.getElementById('scaler');
                    if(clonedScaler) clonedScaler.style.transform = 'none';
                }
            });
            console.log('Capture successful.');

            // 5. æ‰§è¡ŒåŠ¨ä½œ (ä¸‹è½½æˆ–å¤åˆ¶)
            const imgDataUrl = canvas.toDataURL('image/png');
            if (action === 'download') {
                const link = document.createElement('a');
                link.download = `EmbyReport_${currentPeriod}_${document.getElementById('poster-user').innerText.trim()}.png`;
                link.href = imgDataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // å¤åˆ¶éœ€è¦ Blob
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })])
                            .then(() => alert("âœ… å·²æˆåŠŸå¤åˆ¶æµ·æŠ¥åˆ°å‰ªè´´æ¿ï¼"))
                            .catch(err => { console.error(err); alert("âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·å°è¯•ä¸‹è½½ã€‚"); });
                    } else { alert("å½“å‰ç¯å¢ƒä¸æ”¯æŒå¤åˆ¶å›¾ç‰‡ï¼Œè¯·ä½¿ç”¨ä¸‹è½½åŠŸèƒ½ã€‚"); }
                }, 'image/png');
            }
        } catch(e) {
            console.error("Capture failed:", e);
            alert("ğŸ˜¥ ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œå¯èƒ½æ˜¯å› ä¸ºç½‘ç»œé—®é¢˜æˆ–å›¾ç‰‡è·¨åŸŸé™åˆ¶ã€‚\nè¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚");
        } finally {
            // 6. è¿˜åŸç°åœº (éå¸¸é‡è¦)
            if(restoreBgFn) restoreBgFn(); // æ¢å¤èƒŒæ™¯
            scaler.style.transform = currentTransform; // æ¢å¤é¢„è§ˆç¼©æ”¾
            btn.innerHTML = originalText; // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            document.body.style.cursor = 'default';
            triggerResize(); // é‡æ–°æ ¡å‡†é¢„è§ˆ
        }
    }
    
    init();
</script>
{% endblock %}