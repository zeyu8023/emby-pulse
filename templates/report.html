{% extends "layout.html" %}
{% block title %}æ˜ è¿¹å·¥åŠ - EmbyPulse{% endblock %}
{% block head %}
<style>
    .poster-container { 
        width: 375px; 
        height: 667px; 
        box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.5); 
        transform-origin: top center; 
        background-size: cover;
        background-position: center;
        transition: background 0.5s ease;
    }
    /* é»˜è®¤èƒŒæ™¯ (æ·±é‚ƒå¤œç©º) */
    .bg-default { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
    
    .glass-card { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    .user-option.selected { border-color: #16a34a; background-color: #f0fdf4; }
    
    /* èƒŒæ™¯é€‰æ‹©çƒ */
    .bg-option { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .bg-option:hover { transform: scale(1.2); }
    .bg-option.active { border-color: #16a34a; transform: scale(1.1); }
</style>
{% endblock %}

{% block content %}
<div class="flex h-full flex-col md:flex-row overflow-hidden">
    
    <div class="w-full md:w-80 bg-white border-b md:border-b-0 md:border-r border-gray-200 p-4 md:p-6 flex flex-col z-20 shrink-0 max-h-[40vh] md:max-h-full overflow-y-auto">
        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center">
            <i class="fa-solid fa-wand-magic-sparkles text-purple-500 mr-2"></i> é…ç½®æŠ¥å‘Š
        </h2>
        
        <div class="space-y-6 flex-1">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">ä¸»è§’</label>
                <div id="user-list-container" class="flex md:block space-x-2 md:space-x-0 md:space-y-2 overflow-x-auto pb-2 md:pb-0 hide-scrollbar">
                    <p class="text-gray-400 text-xs">æ­£åœ¨åŠ è½½ç”¨æˆ·...</p>
                </div>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">æµ·æŠ¥æ°›å›´</label>
                <div class="flex flex-wrap gap-3">
                    <div class="bg-option active" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%)" onclick="setBg(this, 'linear-gradient(135deg, #1f2937 0%, #111827 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(to right, #434343 0%, black 100%)" onclick="setBg(this, 'linear-gradient(to right, #434343 0%, black 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(to top, #30cfd0 0%, #330867 100%)" onclick="setBg(this, 'linear-gradient(to top, #30cfd0 0%, #330867 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(to top, #5f72bd 0%, #9b23ea 100%)" onclick="setBg(this, 'linear-gradient(to top, #5f72bd 0%, #9b23ea 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%)" onclick="setBg(this, 'linear-gradient(120deg, #d4fc79 0%, #96e6a1 100%)')"></div>
                    <div class="bg-option" style="background: linear-gradient(to right, #fa709a 0%, #fee140 100%)" onclick="setBg(this, 'linear-gradient(to right, #fa709a 0%, #fee140 100%)')"></div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-xs font-bold text-gray-500 uppercase">å¹´åº¦å¯„è¯­</label>
                    <button onclick="randomQuote()" class="text-xs text-blue-500 hover:text-blue-700 flex items-center transition">
                        <i class="fa-solid fa-dice mr-1"></i> æ¢ä¸€å¥
                    </button>
                </div>
                <textarea id="custom-msg" rows="3" class="w-full border-gray-300 rounded-lg text-sm p-2 border focus:ring-green-500 focus:border-green-500 transition" 
                    oninput="document.getElementById('poster-msg').innerText = this.value"
                >ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</textarea>
            </div>
        </div>

        <button onclick="downloadPoster()" id="dl-btn" class="mt-6 w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-lg transition transform active:scale-95 flex justify-center items-center text-sm">
            <i class="fa-solid fa-download mr-2"></i> ä¿å­˜æ˜ è¿¹æµ·æŠ¥
        </button>
    </div>

    <div class="flex-1 bg-gray-100 flex justify-center p-4 md:p-8 overflow-y-auto overflow-x-hidden relative" id="preview-wrapper">
        <div id="scale-wrapper" class="mt-4 md:mt-0">
            <div id="capture-area" class="poster-container flex flex-col relative shrink-0 bg-default">
                
                <div id="poster-backdrop" class="absolute inset-0 z-0 opacity-20 bg-cover bg-center transition-all duration-1000 mix-blend-overlay" style="background-image: url('');"></div>
                
                <div class="absolute inset-0 z-0 bg-gradient-to-t from-black via-black/50 to-transparent opacity-80"></div>

                <div class="relative z-10 p-8 flex-1 flex flex-col text-white">
                    <div class="flex justify-between items-center mb-10">
                        <div class="flex items-center gap-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center font-bold text-xl text-white shadow-lg border-2 border-white/20" id="poster-avatar">
                                U
                            </div>
                            <div>
                                <div class="text-base font-black tracking-wide">EmbyPulse</div>
                                <div class="text-[10px] text-gray-300 font-bold uppercase tracking-[0.2em]">æ˜  è¿¹ Â· æŠ¥ å‘Š</div>
                            </div>
                        </div>
                        <div class="px-3 py-1 border border-white/30 rounded-full text-xs text-gray-300 font-mono bg-white/5 backdrop-blur-sm" id="poster-user">Guest</div>
                    </div>

                    <div class="mb-10">
                        <div class="text-green-400 text-xs font-bold mb-2 tracking-wider uppercase flex items-center">
                            <i class="fa-solid fa-clock mr-2"></i> ä¸“æ³¨æ—¶é•¿
                        </div>
                        <div class="flex items-baseline">
                            <div class="text-7xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400" id="poster-hours">0</div>
                            <span class="ml-3 text-lg text-gray-400 font-medium">Hours</span>
                        </div>
                    </div>

                    <div class="glass-card p-5 grid grid-cols-2 gap-4 rounded-2xl mb-8">
                        <div class="text-center border-r border-white/10">
                            <div class="text-3xl font-bold" id="poster-count">0</div>
                            <div class="text-[10px] text-gray-400 uppercase mt-1 tracking-widest">æ€»æ’­æ”¾æ¬¡æ•°</div>
                        </div>
                        <div class="text-center">
                            <div class="text-3xl font-bold">2026</div>
                            <div class="text-[10px] text-gray-400 uppercase mt-1 tracking-widest">å¹´åº¦æ€»ç»“</div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col justify-center">
                        <div class="text-xs font-bold text-gray-500 uppercase mb-4 tracking-wider flex items-center">
                            <i class="fa-solid fa-crown text-yellow-500 mr-2"></i> å¹´åº¦æœ€çˆ± Top 1
                        </div>
                        <div class="flex gap-5 items-center group bg-white/5 p-4 rounded-xl border border-white/5 hover:bg-white/10 transition">
                            <div class="w-20 h-32 bg-gray-800 rounded-lg shadow-2xl overflow-hidden shrink-0 border border-white/10 transform group-hover:scale-105 transition duration-500">
                                <img id="poster-top-img" src="" class="w-full h-full object-cover opacity-50">
                            </div>
                            <div>
                                <h4 class="font-bold text-xl leading-tight line-clamp-2 mb-2" id="poster-top-title">æš‚æ— æ•°æ®</h4>
                                <div class="text-sm text-gray-400">
                                    <span class="bg-green-600/20 text-green-400 px-2 py-0.5 rounded text-xs">é‡æ¸©</span>
                                    <span class="ml-2" id="poster-top-count">0</span> æ¬¡æ’­æ”¾
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto pt-8">
                        <i class="fa-solid fa-quote-left text-white/20 text-2xl mb-2 block"></i>
                        <p id="poster-msg" class="text-sm text-gray-300 font-light italic leading-relaxed">ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚</p>
                        <div class="mt-6 flex items-center justify-between border-t border-white/10 pt-4">
                            <div class="text-[10px] text-gray-500 uppercase tracking-widest">
                                Generated by <span class="font-bold text-gray-400">EmbyPulse</span>
                            </div>
                            <div class="w-12 h-12 bg-white p-1 rounded-lg">
                                <div class="w-full h-full bg-black flex items-center justify-center text-white text-[8px] font-bold">QR</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ç»å…¸ç”µå½±å°è¯åº“
    const quotes = [
        "ç”Ÿæ´»ä¸ä»…æœ‰ä»£ç ï¼Œè¿˜æœ‰ç”µå½±ã€‚",
        "æœ‰äº›é¸Ÿå„¿æ˜¯å…³ä¸ä½çš„ï¼Œå®ƒä»¬çš„æ¯ä¸€ç‰‡ç¾½æ¯›éƒ½é—ªè€€ç€è‡ªç”±çš„å…‰è¾‰ã€‚",
        "ç”Ÿæ´»å°±åƒä¸€ç›’å·§å…‹åŠ›ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä¸‹ä¸€é¢—æ˜¯ä»€ä¹ˆå‘³é“ã€‚",
        "èƒ½åŠ›è¶Šå¤§ï¼Œè´£ä»»è¶Šå¤§ã€‚",
        "æ„¿åŸåŠ›ä¸ä½ åŒåœ¨ã€‚",
        "å¿µå¿µä¸å¿˜ï¼Œå¿…æœ‰å›å“ã€‚",
        "äººä¸€å®šè¦æœ‰æ¢¦æƒ³ï¼Œä¸ç„¶å’Œå’¸é±¼æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ",
        "ä»¥å‰æˆ‘æ²¡å¾—é€‰ï¼Œç°åœ¨æˆ‘æƒ³åšä¸€ä¸ªå¥½äººã€‚",
        "å³ä¾¿æ˜¯åœ¨æœ€é»‘æš—çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥æ‰¾åˆ°å¹¸ç¦ï¼Œåªè¦ä½ è®°å¾—æ‰“å¼€ç¯ã€‚",
        "æ˜¨å¤©å·²æˆä¸ºå†å²ï¼Œæ˜å¤©æ˜¯æœªçŸ¥çš„è°œå›¢ï¼Œè€Œä»Šå¤©æ˜¯ä¸Šå¤©èµäºˆçš„ç¤¼ç‰©ã€‚",
        "ä¸ºäº†çœ‹çœ‹é˜³å…‰ï¼Œæˆ‘æ¥åˆ°è¿™ä¸–ä¸Šã€‚",
        "æˆ‘å‘½ç”±æˆ‘ä¸ç”±å¤©ï¼",
        "å¦‚æœå†ä¹Ÿä¸èƒ½è§åˆ°ä½ ï¼Œç¥ä½ æ—©å®‰ï¼Œåˆå®‰ï¼Œæ™šå®‰ã€‚",
        "æ¯ä¸€ä¸ªä¸æ›¾èµ·èˆçš„æ—¥å­ï¼Œéƒ½æ˜¯å¯¹ç”Ÿå‘½çš„è¾œè´Ÿã€‚",
        "æˆ‘ä»¬è¦å­¦ä¼šçæƒœï¼Œå› ä¸ºä¸çŸ¥é“å“ªä¸€æ¬¡å†è§ï¼Œå°±æ˜¯æœ€åä¸€æ¬¡ã€‚",
        "æ­»äº¡ä¸æ˜¯ç”Ÿå‘½çš„ç»ˆç‚¹ï¼Œé—å¿˜æ‰æ˜¯ã€‚",
        "é£èµ·ï¼Œå”¯æœ‰åŠªåŠ›ç”Ÿå­˜ã€‚",
        "å¸Œæœ›æ˜¯ç¾å¥½çš„ï¼Œä¹Ÿè®¸æ˜¯äººé—´è‡³å–„ï¼Œè€Œç¾å¥½çš„äº‹ç‰©æ°¸ä¸æ¶ˆé€ã€‚",
        "ä¸ç®¡ä½ æ˜¯åœ¨ä¸€è‹±å¯¸ä¸€è‹±å¯¸åœ°èµ¢ï¼Œè¿˜æ˜¯ä¸€è‹±é‡Œä¸€è‹±é‡Œåœ°èµ¢ï¼Œèµ¢å°±æ˜¯èµ¢ã€‚",
        "æˆ‘ä¸æ€•åƒä¸‡äººé˜»æŒ¡ï¼Œåªæ€•è‡ªå·±æŠ•é™ã€‚"
    ];

    function resizePoster() {
        if (window.innerWidth < 768) {
            const wrapper = document.getElementById('preview-wrapper');
            const scale = (wrapper.clientWidth - 32) / 375;
            const el = document.getElementById('scale-wrapper');
            if (scale < 1) el.style.transform = `scale(${scale})`;
        }
    }
    window.addEventListener('resize', resizePoster);
    setTimeout(resizePoster, 100);

    async function init() { await loadUsers(); }

    async function loadUsers() {
        const container = document.getElementById('user-list-container');
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            container.innerHTML = '';
            if(json.status === 'success') {
                json.data.forEach((user, index) => {
                    const div = document.createElement('div');
                    div.className = `user-option min-w-[140px] md:min-w-0 p-2 md:p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition flex items-center ${index===0?'selected':''}`;
                    div.innerHTML = `<div class="w-6 h-6 rounded-full bg-green-100 text-green-700 text-xs flex items-center justify-center font-bold mr-2 md:mr-3 shrink-0">${user.UserName[0].toUpperCase()}</div><span class="text-gray-700 font-medium truncate text-sm">${user.UserName}</span>`;
                    div.onclick = () => selectUser(div, user);
                    container.appendChild(div);
                    if (index === 0) selectUser(div, user);
                });
            }
        } catch (e) { container.innerHTML = 'Error'; }
    }

    function selectUser(element, user) {
        document.querySelectorAll('.user-option').forEach(el => { el.classList.remove('selected'); el.classList.remove('bg-green-50'); el.classList.remove('border-green-600'); });
        element.classList.add('selected');
        document.getElementById('poster-user').innerText = user.UserName;
        document.getElementById('poster-avatar').innerText = user.UserName[0].toUpperCase();
        loadUserData(user.UserId);
    }

    async function loadUserData(userId) {
        const resStats = await fetch(`/api/stats/dashboard?user_id=${userId}`);
        const stats = await resStats.json();
        if (stats.status === 'success') {
            document.getElementById('poster-count').innerText = stats.data.total_plays;
            document.getElementById('poster-hours').innerText = Math.round(stats.data.total_duration / 3600);
        }
        const resTop = await fetch(`/api/stats/top_movies?user_id=${userId}`);
        const top = await resTop.json();
        if (top.status === 'success' && top.data.length > 0) {
            const item = top.data[0];
            document.getElementById('poster-top-title').innerText = item.ItemName;
            document.getElementById('poster-top-count').innerText = item.PlayCount;
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            const bgUrl = `/api/proxy/image/${item.ItemId}/backdrop`;
            
            document.getElementById('poster-top-img').src = imgUrl;
            document.getElementById('poster-top-img').classList.remove('opacity-50');
            // è®¾ç½®æµ·æŠ¥çš„å åŠ èƒŒæ™¯å›¾
            document.getElementById('poster-backdrop').style.backgroundImage = `url('${bgUrl}')`;
        } else {
            // é‡ç½®
            document.getElementById('poster-top-title').innerText = "æš‚æ— æ’­æ”¾";
            document.getElementById('poster-top-img').classList.add('opacity-50');
            document.getElementById('poster-backdrop').style.backgroundImage = "";
        }
    }

    // ğŸ² éšæœºæ–‡æ¡ˆåŠŸèƒ½
    function randomQuote() {
        const randomIndex = Math.floor(Math.random() * quotes.length);
        const quote = quotes[randomIndex];
        document.getElementById('custom-msg').value = quote;
        document.getElementById('poster-msg').innerText = quote;
    }

    // ğŸ¨ èƒŒæ™¯åˆ‡æ¢åŠŸèƒ½
    function setBg(el, bgStyle) {
        // ç§»é™¤å…¶ä»–æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.bg-option').forEach(opt => opt.classList.remove('active'));
        el.classList.add('active');
        
        // åº”ç”¨èƒŒæ™¯
        document.getElementById('capture-area').style.background = bgStyle;
    }

    function downloadPoster() {
        const node = document.getElementById('capture-area');
        const btn = document.getElementById('dl-btn');
        const originalText = btn.innerHTML;
        const userName = document.getElementById('poster-user').innerText;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> ç”Ÿæˆä¸­...';
        
        html2canvas(node, { scale: 2, useCORS: true, backgroundColor: null }).then(canvas => {
            const link = document.createElement('a');
            link.download = `EmbyPulse_Report_${userName}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            btn.innerHTML = originalText;
        });
    }
    
    init();
</script>
{% endblock %}
