{% extends "layout.html" %}
{% block title %}Êò†ËøπÂ∑•Âùä - ÊóóËà∞Áâà{% endblock %}
{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
<style>
    /* ... (‰øùÁïôÂ§¥ÈÉ®ÈÄöÁî®Ê†∑Âºè) ... */
    html, body { height: 100%; margin: 0; background: #f3f4f6; font-family: "Microsoft YaHei", -apple-system, sans-serif !important; overflow: hidden; }
    .app-container { display: flex; height: 100%; }
    .preview-area { flex: 1; overflow-y: auto; display: flex; justify-content: center; align-items: flex-start; padding: 40px 20px; padding-top: 30px; background-color: #e5e7eb; -webkit-overflow-scrolling: touch; padding-bottom: 140px; }
    .control-panel { width: 360px; background: white; padding: 20px; border-left: 1px solid #ddd; z-index: 50; display: block; box-shadow: -5px 0 15px rgba(0,0,0,0.05); overflow-y: auto; }
    .mobile-toolbar { display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.1); z-index: 500; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
    .toolbar-btn { flex: 1; height: 44px; border-radius: 8px; border: none; font-weight: bold; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .btn-config { background: #f3f4f6; color: #333; margin-right: 10px; border: 1px solid #ddd; }
    .btn-save { background: #16a34a; color: white; flex: 1.5; box-shadow: 0 2px 8px rgba(22, 163, 74, 0.3); }
    .bottom-sheet { display: block; visibility: hidden; position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 25px; padding-bottom: 40px; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); z-index: 600; transform: translateY(100%); transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); max-height: 85vh; overflow-y: auto; }
    .bottom-sheet.active { visibility: visible; transform: translateY(0); }
    .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .sheet-title { font-weight: 900; font-size: 18px; color: #333; }
    .sheet-close { width: 30px; height: 30px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; color: #666; cursor: pointer; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 550; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
    .overlay.active { opacity: 1; pointer-events: auto; }
    @media (max-width: 768px) { .app-container { flex-direction: column; } .control-panel { display: none !important; } .mobile-toolbar { display: flex; } .preview-area { align-items: flex-start; } }
    
    :root { --theme-bg: #1a1a1a; --theme-card: rgba(255,255,255,0.08); --theme-text: white; --theme-highlight: #eab308; }
    .poster-canvas { width: 400px; height: fit-content; min-height: auto; padding-bottom: 20px; background: var(--theme-bg); color: var(--theme-text); position: relative; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 30px 60px rgba(0,0,0,0.5); line-height: 1.6; font-family: "Microsoft YaHei", sans-serif !important; transition: background 0.3s; transform-origin: top center; }
    #poster-bg-img { position: absolute; inset: 0; z-index: 0; background-size: cover; background-position: center; filter: blur(50px) brightness(0.4); transform: scale(1.2); opacity: 0; transition: opacity 0.5s; height: 100%; }
    #poster-bg-gradient { position: absolute; inset: 0; z-index: 1; background: linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.5) 100%); height: 100%; }
    .p-content { position: relative; z-index: 10; padding: 40px 30px; display: block; }
    .p-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .user-box { display: flex; align-items: center; gap: 12px; }
    
    /* üî• ‰øÆÊ≠£Â§¥ÂÉè CSS */
    .avatar { 
        width: 54px; height: 54px; border-radius: 50%; 
        background-color: #e5e7eb; 
        display: flex; align-items: center; justify-content: center; 
        font-size: 26px; 
        color: white; 
        border: 2px solid rgba(255,255,255,0.8); 
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        /* Âº∫Âà∂‰ΩøÁî® cover Â°´ÂÖÖÔºåÈò≤Ê≠¢ÂèòÂΩ¢ */
        background-size: cover !important; 
        background-position: center !important; 
        background-repeat: no-repeat !important;
        z-index: 20; position: relative;
    }
    
    .user-info h1 { font-size: 24px; font-weight: 900; margin: 0; padding: 4px 0; }
    .user-info p { font-size: 11px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; margin: 0; padding-bottom: 2px; }
    .server-pill { background: var(--theme-card); padding: 4px 10px; border-radius: 20px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .server-pill span { display: block; font-weight: 900; font-size: 12px; color: #4ade80; padding-bottom: 2px; }
    .stats-row { display: flex; gap: 10px; margin-bottom: 25px; }
    .stat-card { flex: 1; background: var(--theme-card); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; backdrop-filter: blur(10px); }
    .stat-val { font-size: 28px; font-weight: 900; line-height: 1; margin-bottom: 4px; padding-bottom: 4px; }
    .stat-label { font-size: 9px; opacity: 0.6; text-transform: uppercase; font-weight: bold; }
    .podium-container { display: grid; grid-template-columns: 1fr 1.2fr 1fr; gap: 10px; align-items: end; margin-bottom: 30px; margin-top: 10px; }
    .podium-item { position: relative; display: flex; flex-direction: column; align-items: center; }
    .podium-cover { width: 100%; aspect-ratio: 2/3; border-radius: 8px; background-color: #333; background-size: cover; background-position: center; box-shadow: 0 10px 20px rgba(0,0,0,0.3); position: relative; border: 2px solid transparent; }
    .podium-item.rank-1 .podium-cover { border-color: #eab308; transform: scale(1.05); z-index: 5; box-shadow: 0 0 20px rgba(234, 179, 8, 0.4); }
    .podium-item.rank-2 .podium-cover { border-color: #94a3b8; }
    .podium-item.rank-3 .podium-cover { border-color: #b45309; }
    .medal { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; z-index: 10; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .medal.rank-1 { background: linear-gradient(135deg, #fcd34d, #b45309); width: 32px; height: 32px; top: -16px; font-size: 14px; }
    .medal.rank-2 { background: linear-gradient(135deg, #e2e8f0, #64748b); }
    .medal.rank-3 { background: linear-gradient(135deg, #fdba74, #9a3412); }
    .podium-info { text-align: center; margin-top: 8px; width: 100%; }
    .podium-title { font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; padding-bottom: 4px; }
    .podium-meta { font-size: 9px; opacity: 0.7; }
    .rank-list { display: flex; flex-direction: column; gap: 8px; }
    .rank-row { display: flex; align-items: center; padding: 10px 10px; background: var(--theme-card); border-radius: 10px; backdrop-filter: blur(5px); min-height: 50px; }
    .rank-idx { font-size: 12px; font-weight: 900; opacity: 0.4; width: 25px; text-align: center; }
    .rank-poster-sm { width: 32px; height: 48px; border-radius: 4px; background-color: #333; background-size: cover; background-position: center; margin-right: 12px; flex-shrink: 0; }
    .rank-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
    .rank-name { font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-bottom: 4px; margin-bottom: -2px; }
    .rank-meta-row { font-size: 9px; opacity: 0.7; display: flex; gap: 8px; }
    .p-footer { margin-top: 15px; text-align: center; opacity: 0.4; font-size: 10px; letter-spacing: 2px; }
    .empty-box { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; min-height: 200px; text-align: center; }
    .ctrl-label { font-size: 12px; font-weight: bold; color: #666; margin-bottom: 8px; display: block; }
    .btn-group { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .btn { flex: 1; padding: 10px; border: 1px solid #ddd; background: #fff; font-weight: bold; border-radius: 8px; font-size: 12px; cursor: pointer; min-width: 60px; white-space: nowrap; }
    .btn.active { background: #111827; color: white; border-color: #111827; }
    .theme-dots { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
    .dot { height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: bold; text-shadow: 0 1px 2px black; }
</style>
{% endblock %}

{% block content %}
<div class="app-container">
    <div class="preview-area">
        <div id="scale-wrapper">
            <div id="capture-target" class="poster-canvas">
                <div id="poster-bg-img" data-src=""></div>
                <div id="poster-bg-gradient"></div>
                <div class="p-content">
                    <div class="p-header">
                        <div class="user-box">
                            <div class="avatar" id="p-avatar"></div>
                            <div class="user-info">
                                <h1 id="p-user">User</h1>
                                <p id="p-period">ÂÖ®ÈáèËßÇÂΩ±Êä•Âëä</p>
                            </div>
                        </div>
                        <div class="server-pill"><span id="p-server">0</span>ÂÖ®ÊúçÊÄªÊí≠</div>
                    </div>
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-val" id="p-hours">0</div>
                            <div class="stat-label">‰∏ìÊ≥®Êó∂Èïø (H)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-val" id="p-plays">0</div>
                            <div class="stat-label">Êí≠ÊîæÊ¨°Êï∞</div>
                        </div>
                    </div>
                    <div id="content-area">
                        <div id="podium-area" class="podium-container" style="display:none;">
                            <div class="podium-item rank-2" id="rank2-box" style="visibility: hidden;">
                                <div class="medal rank-2">2</div>
                                <div class="podium-cover" id="rank2-img" data-src=""></div>
                                <div class="podium-info"><div class="podium-title" id="rank2-title">-</div><div class="podium-meta" id="rank2-meta">0Ê¨°</div></div>
                            </div>
                            <div class="podium-item rank-1" id="rank1-box">
                                <div class="medal rank-1"><i class="fa-solid fa-crown"></i></div>
                                <div class="podium-cover" id="rank1-img" data-src=""></div>
                                <div class="podium-info"><div class="podium-title" id="rank1-title">-</div><div class="podium-meta" id="rank1-meta">0Ê¨°</div></div>
                            </div>
                            <div class="podium-item rank-3" id="rank3-box" style="visibility: hidden;">
                                <div class="medal rank-3">3</div>
                                <div class="podium-cover" id="rank3-img" data-src=""></div>
                                <div class="podium-info"><div class="podium-title" id="rank3-title">-</div><div class="podium-meta" id="rank3-meta">0Ê¨°</div></div>
                            </div>
                        </div>
                        <div class="rank-list" id="rank-list"></div>
                    </div>
                    <div id="empty-area" class="empty-box" style="display:none;"><i class="fa-solid fa-ghost" style="font-size: 40px; margin-bottom: 10px;"></i><p>ËØ•Êó∂ÊÆµÊöÇÊó†ËÆ∞ÂΩï</p></div>
                    <div class="p-footer">GENERATED BY EMBY PULSE</div>
                </div>
            </div>
        </div>
    </div>

    <div class="control-panel">
        <div id="desktop-controls-container"></div>
    </div>

    <div class="mobile-toolbar">
        <button class="toolbar-btn btn-config" onclick="toggleSheet()">
            <i class="fa-solid fa-sliders"></i> ÂèÇÊï∞ÈÖçÁΩÆ
        </button>
        <button class="toolbar-btn btn-save" onclick="savePoster()" id="mobile-save-btn">
            <i class="fa-solid fa-download"></i> ‰øùÂ≠òÊµ∑Êä•
        </button>
    </div>

    <div class="overlay" id="mobile-overlay" onclick="toggleSheet(false)"></div>
    <div class="bottom-sheet" id="mobile-sheet">
        <div class="sheet-header">
            <div class="sheet-title">ÈÖçÁΩÆÈÄâÈ°π</div>
            <div class="sheet-close" onclick="toggleSheet(false)"><i class="fa-solid fa-xmark"></i></div>
        </div>
        <div id="mobile-controls-container">
            <label class="ctrl-label">ÈÄâÊã©Áî®Êà∑</label>
            <select id="user-select" onchange="changeUser(this.value)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;">
                <option>Loading...</option>
            </select>

            <label class="ctrl-label">Êó∂Èó¥ËåÉÂõ¥</label>
            <div class="btn-group">
                <button class="btn" onclick="setPeriod('all', this)">ÂÖ®Èáè</button>
                <button class="btn" onclick="setPeriod('year', this)">Âπ¥Â∫¶</button>
                <button class="btn active" onclick="setPeriod('month', this)">Êú¨Êúà</button>
                <button class="btn" onclick="setPeriod('week', this)">Êú¨Âë®</button>
            </div>

            <label class="ctrl-label">‰∏ªÈ¢òÈÖçËâ≤</label>
            <div class="theme-dots">
                <div class="dot" style="background: #1a1a1a;" onclick="setTheme('#1a1a1a', 'white')">ÈªëÈáë</div>
                <div class="dot" style="background: #2e1065;" onclick="setTheme('#2e1065', 'white')">ËµõÂçö</div>
                <div class="dot" style="background: #0f172a;" onclick="setTheme('#0f172a', 'white')">Ê∑±Êµ∑</div>
                <div class="dot" style="background: #064e3b;" onclick="setTheme('#064e3b', 'white')">ÊûÅÂÖâ</div>
                <div class="dot" style="background: #7f1d1d;" onclick="setTheme('#7f1d1d', 'white')">ÁÜîÂ≤©</div>
                <div class="dot" style="background: linear-gradient(135deg, #c2410c, #7c2d12);" onclick="setTheme('linear-gradient(135deg, #c2410c, #7c2d12)', 'white')">ËêΩÊó•</div>
                <div class="dot" style="background: #525252;" onclick="setTheme('#525252', 'white')">Ê∞¥Ê≥•</div>
                <div class="dot" style="background: #ffffff; color:#333; text-shadow:none; border:1px solid #ccc;" onclick="setTheme('#ffffff', '#333')">Á∫ØÁôΩ</div>
            </div>
            
            <button onclick="toggleCoverBg()" class="btn" style="width: 100%; margin-bottom: 15px; border: 1px dashed #999;">üñºÔ∏è ‰ΩøÁî® Top1 Â∞ÅÈù¢ËÉåÊôØ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    window.onerror = function(msg) { alert("ÂèëÁîüÈîôËØØ: " + msg); return false; };
</script>
<script>
    let currentUserId = '';
    let currentUserName = 'User';
    let currentPeriod = 'month';

    function checkLayout() {
        const isMobile = window.innerWidth <= 768;
        const controlsHTML = document.getElementById('mobile-controls-container').innerHTML;
        const desktopContainer = document.getElementById('desktop-controls-container');
        if (!isMobile && desktopContainer.innerHTML.trim() === '') {
            desktopContainer.innerHTML = controlsHTML + 
            `<button onclick="savePoster()" id="pc-save-btn" style="width: 100%; padding: 12px; background: #16a34a; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 14px; margin-top: 20px;"><i class="fa-solid fa-download"></i> ‰øùÂ≠òÊµ∑Êä•</button>`;
        }
    }
    window.addEventListener('resize', () => { fitScale(); checkLayout(); });
    setTimeout(() => { fitScale(); checkLayout(); }, 100);

    function toggleSheet(forceState) {
        const sheet = document.getElementById('mobile-sheet');
        const overlay = document.getElementById('mobile-overlay');
        let shouldShow = false;
        if (typeof forceState === 'boolean') { shouldShow = forceState; } 
        else { shouldShow = !sheet.classList.contains('active'); }

        if(shouldShow) { sheet.classList.add('active'); overlay.classList.add('active'); } 
        else { sheet.classList.remove('active'); overlay.classList.remove('active'); }
    }

    function fitScale() {
        const wrapper = document.querySelector('.preview-area');
        const w = wrapper.clientWidth;
        const scale = Math.min((w - 40) / 400, 1);
        document.getElementById('scale-wrapper').style.transform = `scale(${scale})`;
        document.getElementById('scale-wrapper').style.transformOrigin = 'top center';
    }

    async function toBase64(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status}`); 
            const blob = await res.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        } catch(e) { return null; }
    }

    function getDateLabel(period) {
        const now = new Date();
        const y = now.getFullYear();
        const m = now.getMonth() + 1;
        if (period === 'year') return `${y} Âπ¥Â∫¶ËßÇÂΩ±Êä•Âëä`;
        if (period === 'month') return `${y}Âπ¥${m}Êúà ËßÇÂΩ±Êä•Âëä`;
        if (period === 'week') {
            const day = now.getDay() || 7; 
            const start = new Date(now); start.setDate(now.getDate() - day + 1);
            const end = new Date(now); end.setDate(now.getDate() - day + 7);
            const fmt = d => `${d.getMonth()+1}Êúà${d.getDate()}Êó•`;
            return `${fmt(start)} - ${fmt(end)} ËßÇÂΩ±Âë®Êä•`;
        }
        return 'ÂéÜÂè≤ÂÖ®Èáè ËßÇÂΩ±Êä•Âëä';
    }

    function setTheme(bg, text) {
        const canvas = document.querySelector('.poster-canvas');
        canvas.style.background = bg;
        canvas.style.color = text;
        document.getElementById('poster-bg-img').style.opacity = '0';
        if(text === '#333') {
            document.documentElement.style.setProperty('--theme-card', 'rgba(0,0,0,0.05)');
            document.getElementById('poster-bg-gradient').style.background = 'transparent';
        } else {
            document.documentElement.style.setProperty('--theme-card', 'rgba(255,255,255,0.08)');
            document.getElementById('poster-bg-gradient').style.background = 'linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.5))';
        }
    }

    function toggleCoverBg() {
        const bgImg = document.getElementById('poster-bg-img');
        if(bgImg.style.opacity === '1') {
            bgImg.style.opacity = '0';
        } else {
            bgImg.style.opacity = '1';
            document.documentElement.style.setProperty('--theme-card', 'rgba(255,255,255,0.08)');
            document.querySelector('.poster-canvas').style.color = 'white';
            document.getElementById('poster-bg-gradient').style.background = 'linear-gradient(to bottom, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.8) 100%)';
        }
    }

    function getIconAvatar(name) {
        const icons = ['fa-robot', 'fa-cat', 'fa-ghost', 'fa-dragon', 'fa-user-astronaut', 'fa-snowman', 'fa-frog', 'fa-hippo', 'fa-dog', 'fa-otter', 'fa-kiwi-bird', 'fa-crow', 'fa-fish', 'fa-spider', 'fa-dove', 'fa-paw'];
        const colors = ['#FFC0CB', '#FFB6C1', '#FF69B4', '#E6E6FA', '#D8BFD8', '#B0C4DE', '#ADD8E6', '#87CEFA', '#98FB98', '#90EE90', '#F0E68C', '#FFD700', '#FFA07a', '#FF7F50', '#00CED1', '#20B2AA'];
        
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        
        const icon = icons[Math.abs(hash % icons.length)];
        const color = colors[Math.abs(hash % colors.length)];
        return { icon, color };
    }

    async function loadAvatar() {
        const avatarEl = document.getElementById('p-avatar');
        avatarEl.style.backgroundImage = 'none';
        avatarEl.innerText = '';
        
        if (currentUserId === 'all') {
            avatarEl.style.background = 'linear-gradient(135deg, #1a1a1a, #333)';
            avatarEl.innerHTML = '<i class="fa-solid fa-server"></i>';
            avatarEl.style.color = 'white';
            return;
        }
        
        const realUrl = `/api/proxy/user_image/${currentUserId}`;
        const b64 = await toBase64(realUrl);

        if (b64) {
            avatarEl.style.backgroundImage = `url('${b64}')`;
            avatarEl.innerHTML = ''; 
            avatarEl.dataset.src = realUrl;
        } else {
            const style = getIconAvatar(currentUserName);
            avatarEl.style.backgroundColor = style.color;
            avatarEl.style.backgroundImage = 'none';
            avatarEl.innerHTML = `<i class="fa-solid ${style.icon}"></i>`;
            avatarEl.style.color = 'white'; 
            avatarEl.style.textShadow = '0 1px 3px rgba(0,0,0,0.2)'; 
        }
    }

    async function init() {
        const res = await fetch('/api/users');
        const json = await res.json();
        const selects = document.querySelectorAll('#user-select');
        selects.forEach(sel => {
            sel.innerHTML = '';
            
            const optAll = document.createElement('option');
            optAll.value = 'all';
            optAll.innerText = 'ÂÖ®ÊúçÊ¶ÇËßà (All Users)';
            sel.appendChild(optAll);

            if(json.data) {
                json.data.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.UserId; opt.innerText = u.UserName;
                    sel.appendChild(opt);
                });
            }
        });
        
        changeUser('all');
    }

    function changeUser(uid) {
        currentUserId = uid;
        document.querySelectorAll('#user-select').forEach(s => s.value = uid);
        
        const sel = document.querySelector('#user-select');
        for(let opt of sel.options) {
            if(opt.value === uid) {
                currentUserName = opt.text;
                break;
            }
        }
        if(uid === 'all') currentUserName = 'Emby Server';

        document.getElementById('p-user').innerText = currentUserName;
        loadAvatar();
        loadData();
    }

    function setPeriod(p, btn) {
        currentPeriod = p;
        document.querySelectorAll('.btn-group .btn').forEach(b => {
            if(b.innerText === btn.innerText) b.classList.add('active');
            else b.classList.remove('active');
        });
        loadData();
    }

    async function loadData() {
        if(!currentUserId) return;
        const res = await fetch(`/api/stats/poster_data?user_id=${currentUserId}&period=${currentPeriod}`);
        const json = await res.json();
        const data = json.data;

        document.getElementById('p-period').innerText = getDateLabel(currentPeriod);
        document.getElementById('p-plays').innerText = data.plays;
        document.getElementById('p-hours').innerText = data.hours;
        document.getElementById('p-server').innerText = data.server_plays;

        const hasData = data.plays > 0;
        document.getElementById('content-area').style.display = hasData ? 'block' : 'none';
        document.getElementById('empty-area').style.display = hasData ? 'none' : 'flex';

        if(hasData) {
            const list = data.top_list;
            const podiumArea = document.getElementById('podium-area');
            
            if(list.length > 0) {
                podiumArea.style.display = 'grid';
                const renderRank = async (rank, idx) => {
                    const el = document.getElementById(`rank${rank}-box`);
                    if(list[idx]) {
                        el.style.visibility = 'visible';
                        document.getElementById(`rank${rank}-title`).innerText = list[idx].ItemName;
                        const h = Math.round(list[idx].Duration/3600);
                        const t = h > 0 ? ` ¬∑ ${h}Â∞èÊó∂` : '';
                        document.getElementById(`rank${rank}-meta`).innerText = `${list[idx].Count}Ê¨°${t}`;
                        
                        const imgUrl = `/api/proxy/image/${list[idx].ItemId}/primary`;
                        const b64 = await toBase64(imgUrl);
                        const coverEl = document.getElementById(`rank${rank}-img`);
                        if(b64) {
                            coverEl.style.backgroundImage = `url('${b64}')`;
                            coverEl.dataset.src = imgUrl;
                            if(rank === 1) {
                                document.getElementById('poster-bg-img').style.backgroundImage = `url('${b64}')`;
                                document.getElementById('poster-bg-img').dataset.src = imgUrl;
                            }
                        } else { coverEl.style.backgroundColor = '#333'; }
                    } else { el.style.visibility = 'hidden'; }
                };
                await renderRank(1, 0); await renderRank(2, 1); await renderRank(3, 2); 
            } else { podiumArea.style.display = 'none'; }

            const listEl = document.getElementById('rank-list');
            let html = '';
            const max = Math.min(list.length, 10);
            for(let i=3; i<max; i++) {
                const hours = Math.round(list[i].Duration/3600);
                const timeText = hours > 0 ? `${hours}h` : '<1h';
                const imgUrl = `/api/proxy/image/${list[i].ItemId}/primary`;
                html += `
                <div class="rank-row">
                    <div class="rank-idx">${i+1}</div>
                    <div class="rank-poster-sm" style="background-image: url('${imgUrl}')" data-src="${imgUrl}"></div>
                    <div class="rank-info">
                        <div class="rank-name">${list[i].ItemName}</div>
                        <div class="rank-meta-row"><span>${list[i].Count}Ê¨°</span><span>${timeText}</span></div>
                    </div>
                </div>`;
            }
            listEl.innerHTML = html;
            setTimeout(async () => {
                const smPosters = listEl.querySelectorAll('.rank-poster-sm');
                for(let el of smPosters) {
                    const url = el.dataset.src;
                    const b64 = await toBase64(url);
                    if(b64) el.style.backgroundImage = `url('${b64}')`;
                }
            }, 100);
        }
    }

    async function savePoster() {
        const btns = document.querySelectorAll('#save-btn');
        btns.forEach(b => b.innerText = 'ÁîüÊàê‰∏≠...');
        toggleSheet(false); 

        const wrapper = document.getElementById('scale-wrapper');
        const oldT = wrapper.style.transform;
        wrapper.style.transform = 'none';
        await new Promise(r => setTimeout(r, 200)); 
        
        try {
            const allImages = document.getElementById('capture-target').querySelectorAll('[data-src]');
            const promises = Array.from(allImages).map(async (el) => {
                if(el.dataset.src && !el.style.backgroundImage.includes('base64')) {
                    const b64 = await toBase64(el.dataset.src);
                    if(b64) el.style.backgroundImage = `url('${b64}')`;
                }
            });
            await Promise.all(promises);

            const canvas = await html2canvas(document.getElementById('capture-target'), { 
                scale: 2, useCORS: true, backgroundColor: null 
            });
            const link = document.createElement('a');
            link.download = `EmbyReport_${currentUserId}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } catch(e) { alert('Err: ' + e); } 
        finally { 
            wrapper.style.transform = oldT; 
            btns.forEach(b => b.innerHTML = '<i class="fa-solid fa-download"></i> ‰øùÂ≠òÊµ∑Êä•');
        }
    }

    init();
</script>
{% endblock %}