{% extends "layout.html" %}
{% block title %}æ•°æ®æ´å¯Ÿ - EmbyPulse{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto w-full px-4 md:px-8 py-6 pb-20">
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-2xl font-black text-gray-900">æ•°æ®æ´å¯Ÿ</h1>
            <p class="text-xs text-gray-500 mt-1">æ·±åº¦åˆ†æç”¨æˆ·è¡Œä¸ºç”»åƒ</p>
        </div>
        <div class="w-full md:w-auto bg-white p-1 rounded-xl shadow-sm border border-gray-200">
             <select id="user-select" onchange="changeUser()" class="w-full md:w-48 appearance-none bg-transparent text-gray-700 py-2 pl-4 pr-10 rounded-lg text-sm font-bold focus:outline-none cursor-pointer">
                <option value="all">ğŸŒ å…¨æœæ•°æ®</option>
            </select>
        </div>
    </div>

    <div id="loading" class="text-center py-20 text-gray-400">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl"></i>
        <p class="mt-2 text-xs">æ­£åœ¨æŒ–æ˜æ•°æ®...</p>
    </div>

    <div id="content-area" class="hidden animate-fade-in space-y-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col justify-center">
                <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center">
                    <i class="fa-solid fa-medal text-yellow-500 mr-2"></i> ç”¨æˆ·æˆå°±
                </h3>
                <div id="badges-container" class="flex flex-wrap gap-2"></div>
            </div>
            
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 text-sm flex items-center">
                        <i class="fa-solid fa-chart-bar text-green-600 mr-2"></i> è§‚å½±è¶‹åŠ¿ç»Ÿè®¡
                    </h3>
                    <div class="flex bg-gray-100 rounded-lg p-1 text-xs">
                        <button onclick="switchChart('day')" class="chart-btn px-3 py-1 rounded transition text-gray-500 hover:text-gray-900" id="btn-day">æ—¥</button>
                        <button onclick="switchChart('month')" class="chart-btn px-3 py-1 rounded bg-white shadow-sm text-gray-900 font-bold transition" id="btn-month">æœˆ</button>
                        <button onclick="switchChart('year')" class="chart-btn px-3 py-1 rounded transition text-gray-500 hover:text-gray-900" id="btn-year">å¹´</button>
                    </div>
                </div>
                <div class="relative h-48 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center"><i class="fa-regular fa-clock text-blue-500 mr-2"></i> 24å°æ—¶ä½œæ¯åˆ†å¸ƒ</h3>
                <div class="relative h-60 w-full"><canvas id="hourlyChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm">
                <h3 class="font-bold text-gray-800 mb-4 text-sm flex items-center"><i class="fa-solid fa-mobile-screen-button text-purple-500 mr-2"></i> è§‚çœ‹è®¾å¤‡åˆ†å¸ƒ</h3>
                <div class="relative h-60 w-full flex justify-center"><canvas id="deviceChart"></canvas></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50/50">
                <h3 class="font-bold text-gray-700 text-sm">æœ€è¿‘ 100 æ¡æ’­æ”¾æ˜ç»†</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr><th class="px-6 py-3">æ—¶é—´</th><th class="px-6 py-3">ç”¨æˆ·</th><th class="px-6 py-3">å†…å®¹</th><th class="px-6 py-3">è®¾å¤‡</th><th class="px-6 py-3 text-right">æ—¶é•¿</th></tr>
                    </thead>
                    <tbody id="logs-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    let charts = {};
    let currentDim = 'month';

    async function init() {
        await loadUsers();
        loadAllData();
    }

    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            const select = document.getElementById('user-select');
            if(json.status === 'success') {
                json.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.UserId;
                    option.innerText = `ğŸ‘¤ ${user.UserName}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error(e); }
    }

    function changeUser() { loadAllData(); }

    function switchChart(dim) {
        currentDim = dim;
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'shadow-sm', 'text-gray-900', 'font-bold');
            btn.classList.add('text-gray-500');
        });
        const activeBtn = document.getElementById(`btn-${dim}`);
        activeBtn.classList.add('bg-white', 'shadow-sm', 'text-gray-900', 'font-bold');
        activeBtn.classList.remove('text-gray-500');
        
        loadTrendChart();
    }

    async function loadAllData() {
        const userId = document.getElementById('user-select').value;
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content-area').classList.add('hidden');

        await Promise.all([
            loadTrendChart(),
            loadDetails(userId),
            loadBadges(userId)
        ]);

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content-area').classList.remove('hidden');
    }

    async function loadTrendChart() {
        const userId = document.getElementById('user-select').value;
        try {
            const res = await fetch(`/api/stats/chart?user_id=${userId}&dimension=${currentDim}`);
            const json = await res.json();
            const data = json.data || {};
            
            const labels = Object.keys(data);
            const values = Object.values(data).map(v => Math.round(v/3600));

            const ctx = document.getElementById('trendChart').getContext('2d');
            if(charts.trend) charts.trend.destroy();

            charts.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ—¶é•¿ (å°æ—¶)',
                        data: values,
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: {display: false} },
                        y: { beginAtZero: true, grid: {borderDash: [2, 4]} }
                    },
                    plugins: { legend: {display: false} }
                }
            });
        } catch(e) { console.error("Trend Chart Error:", e); }
    }

    async function loadDetails(userId) {
        try {
            const res = await fetch(`/api/stats/user_details?user_id=${userId}`);
            const json = await res.json();
            if(json.status === 'success') {
                const data = json.data;
                renderHourlyChart(data.hourly);
                renderDeviceChart(data.devices);
                renderLogs(data.logs);
            }
        } catch (e) { console.error("Details Load Error:", e); }
    }

    async function loadBadges(userId) {
        const container = document.getElementById('badges-container');
        try {
            const res = await fetch(`/api/stats/badges?user_id=${userId}`);
            const json = await res.json();
            if(json.status === 'success' && json.data.length > 0) {
                let html = '';
                json.data.forEach(b => {
                    html += `<div class="flex items-center space-x-2 px-3 py-2 rounded-lg border border-gray-100 bg-gray-50 hover:bg-white hover:shadow-sm transition cursor-default group">
                        <div class="w-8 h-8 rounded-full ${b.bg} flex items-center justify-center shrink-0">
                            <i class="fa-solid ${b.icon} ${b.color}"></i>
                        </div>
                        <div>
                            <p class="text-xs font-bold text-gray-800">${b.name}</p>
                            <p class="text-[10px] text-gray-400 group-hover:text-gray-500">${b.desc}</p>
                        </div>
                    </div>`;
                });
                container.innerHTML = html;
            } else { 
                container.innerHTML = '<p class="text-xs text-gray-400 py-4">æš‚æ— ç‰¹æ®Šæˆå°±ï¼Œç»§ç»­è§‚çœ‹ä»¥è§£é”ï¼</p>'; 
            }
        } catch(e) { console.error("Badges Error:", e); }
    }

    function renderHourlyChart(dataObj) {
        const ctx = document.getElementById('hourlyChart').getContext('2d');
        if(charts.hourly) charts.hourly.destroy();
        
        const labels = Object.keys(dataObj);
        const values = Object.values(dataObj);
        
        charts.hourly = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: labels, 
                datasets: [{ 
                    label: 'æ’­æ”¾', 
                    data: values, 
                    backgroundColor: 'rgba(59, 130, 246, 0.6)', 
                    borderRadius: 4 
                }] 
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                scales: { 
                    x: {grid:{display:false}}, 
                    y: {beginAtZero:true, border:{display:false}} 
                }, 
                plugins: {legend:{display:false}} 
            }
        });
    }

    function renderDeviceChart(dataList) {
        const ctx = document.getElementById('deviceChart').getContext('2d');
        if(charts.device) charts.device.destroy();
        
        if(!dataList || dataList.length === 0) {
             return;
        }

        let labels = [], values = [], others = 0;
        dataList.forEach((d, i) => { if(i < 5) { labels.push(d.Device); values.push(d.Plays); } else { others += d.Plays; } });
        if(others > 0) { labels.push('å…¶ä»–'); values.push(others); }
        
        charts.device = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: labels, datasets: [{ data: values, backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#cbd5e1'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {boxWidth: 10} } } }
        });
    }

    function renderLogs(logs) {
        const tbody = document.getElementById('logs-table-body');
        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-8 text-center text-gray-400">æš‚æ— æ’­æ”¾è®°å½•</td></tr>';
            return;
        }

        let html = '';
        logs.forEach(log => {
            // ğŸ”¥ ä¿®å¤æ—¶é—´è§£æï¼šå¤„ç† "YYYY-MM-DD HH:MM:SS" ä¸º ISO æ ¼å¼
            let dateStr = log.DateCreated;
            if (dateStr && dateStr.includes(' ')) {
                dateStr = dateStr.replace(' ', 'T');
            }
            const dateObj = new Date(dateStr);
            const date = dateObj.toLocaleString('zh-CN', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
            
            // æ™ºèƒ½è®¾å¤‡å›¾æ ‡æ˜ å°„
            let deviceIcon = 'fa-mobile-screen';
            const d = (log.Device || '').toLowerCase();
            if(d.includes('browser') || d.includes('chrome')) deviceIcon = 'fa-globe';
            else if(d.includes('tv')) deviceIcon = 'fa-tv';
            else if(d.includes('apple')) deviceIcon = 'fa-apple';
            
            html += `<tr class="bg-white border-b hover:bg-gray-50 transition">
                <td class="px-6 py-3 font-medium text-gray-900 whitespace-nowrap">${date}</td>
                <td class="px-6 py-3">${log.UserName}</td>
                <td class="px-6 py-3 font-bold text-gray-800 line-clamp-1 max-w-xs" title="${log.ItemName}">${log.ItemName}</td>
                <td class="px-6 py-3 text-xs">
                    <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded-md border border-gray-200 flex items-center w-fit gap-1.5">
                        <i class="fa-solid ${deviceIcon} text-[10px]"></i> ${log.Device}
                    </span>
                </td>
                <td class="px-6 py-3 text-right font-bold text-green-600">${Math.round(log.PlayDuration/60)}m</td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }
    init();
</script>
{% endblock %}