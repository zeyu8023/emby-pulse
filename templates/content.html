{% extends "layout.html" %}
{% block title %}å†…å®¹é£äº‘æ¦œ - EmbyPulse{% endblock %}
{% block head %}
<style>
    /* é¢†å¥–å°å¡ç‰‡åŸºç¡€åŠ¨ç”» */
    .podium-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .podium-card:active { transform: scale(0.95); }
    
    /* å† å†›å…‰æ•ˆåŠ å¼º */
    .rank-1-border { 
        border-color: #f59e0b; 
        box-shadow: 0 0 25px rgba(245, 158, 11, 0.3); 
    }
    .rank-2-border { border-color: #cbd5e1; }
    .rank-3-border { border-color: #b45309; }

    /* çš‡å† å›¾æ ‡åŠ¨ç”» */
    .crown-icon { 
        position: absolute; 
        top: -20px; 
        left: 50%; 
        transform: translateX(-50%); 
        font-size: 1.8rem; 
        color: #f59e0b; 
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); 
        z-index: 20; 
        animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateX(-50%) translateY(0); }
        50% { transform: translateX(-50%) translateY(-5px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full px-3 md:px-8 py-4 pb-24">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
        <div class="text-center md:text-left">
            <h1 class="text-xl md:text-2xl font-black text-gray-800 dark:text-white flex items-center gap-2 justify-center md:justify-start">
                <i class="fa-solid fa-fire text-red-500"></i> å†…å®¹é£äº‘æ¦œ
            </h1>
            <p class="text-xs text-gray-500 mt-1">å…¨æœæ’­æ”¾çƒ­åº¦ç»Ÿè®¡ (å…¨é‡)</p>
        </div>
        
        <div class="flex flex-wrap justify-center items-center gap-2 bg-white dark:bg-gray-800 p-1.5 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
            <button onclick="setCategory('all')" class="cat-btn px-3 py-1.5 rounded-lg text-xs font-bold transition bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200" data-cat="all">å…¨éƒ¨</button>
            <button onclick="setCategory('Movie')" class="cat-btn px-3 py-1.5 rounded-lg text-xs font-bold transition text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600" data-cat="Movie">ç”µå½±</button>
            <button onclick="setCategory('Episode')" class="cat-btn px-3 py-1.5 rounded-lg text-xs font-bold transition text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-600" data-cat="Episode">å‰§é›†</button>
            
            <div class="w-px h-4 bg-gray-200 dark:bg-gray-600 mx-1"></div>
            
            <select id="user-select" onchange="changeUser()" class="bg-transparent text-xs font-bold text-gray-600 dark:text-gray-300 focus:outline-none cursor-pointer max-w-[90px] truncate">
                <option value="all">ğŸŒ å…¨æœ</option>
            </select>
        </div>
    </div>

    <div id="loading" class="text-center py-20 text-gray-400">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
        <p class="text-xs">æ•°æ®åˆ†æä¸­...</p>
    </div>

    <div id="content-area" class="hidden animate-fade-in space-y-8">
        
        <div class="flex flex-row items-end justify-center gap-2 md:gap-6 px-1 mb-8" id="podium-section">
            </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden max-w-4xl mx-auto w-full">
            <div class="px-5 py-3 border-b border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-700/50 flex justify-between items-center">
                <h3 class="font-bold text-gray-700 dark:text-gray-300 text-xs md:text-sm uppercase tracking-wider">
                    <i class="fa-solid fa-list-ol mr-1"></i> ä¸Šæ¦œåå•
                </h3>
                <span class="text-[10px] md:text-xs text-gray-400 bg-gray-200 dark:bg-gray-600 px-2 py-0.5 rounded-full">Top 4 - 20</span>
            </div>
            <div id="list-section" class="divide-y divide-gray-50 dark:divide-gray-700/50">
                </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // é»˜è®¤å‚æ•°
    let state = { user: 'all', category: 'all', sortBy: 'count', period: 'all' };

    async function init() {
        await loadUsers();
        loadContent();
    }

    function setCategory(cat) {
        state.category = cat;
        // æŒ‰é’®æ ·å¼åˆ‡æ¢
        document.querySelectorAll('.cat-btn').forEach(btn => {
            if(btn.dataset.cat === cat) {
                btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
                btn.classList.remove('text-gray-500', 'dark:text-gray-400');
            } else {
                btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-800', 'dark:text-gray-200');
                btn.classList.add('text-gray-500', 'dark:text-gray-400');
            }
        });
        loadContent();
    }

    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            const select = document.getElementById('user-select');
            if(json.status === 'success') {
                json.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.UserId;
                    option.innerText = `ğŸ‘¤ ${user.UserName}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error("ç”¨æˆ·åŠ è½½å¤±è´¥", e); }
    }

    function changeUser() {
        state.user = document.getElementById('user-select').value;
        loadContent();
    }

    async function loadContent() {
        const loading = document.getElementById('loading');
        const content = document.getElementById('content-area');
        loading.classList.remove('hidden'); 
        content.classList.add('hidden');

        try {
            // ğŸ”¥ å…³é”®ä¿®æ­£ï¼šåŠ ä¸Š period=all ç¡®ä¿èƒ½æ‹‰å–åˆ°å…¨é‡æ•°æ®ï¼Œé¿å…"æš‚æ— æ•°æ®"
            const url = `/api/stats/top_movies?user_id=${state.user}&category=${state.category}&period=${state.period}&sort_by=${state.sortBy}`;
            
            const res = await fetch(url);
            const json = await res.json();
            
            if(json.status === 'success' && json.data && json.data.length > 0) {
                const list = json.data;
                const top3 = [];
                // æ„é€ å‰ä¸‰åæ•°æ®
                if(list[0]) top3.push({...list[0], rank: 1});
                if(list[1]) top3.push({...list[1], rank: 2});
                if(list[2]) top3.push({...list[2], rank: 3});
                
                const others = list.slice(3); // ç¬¬4åä»¥å

                renderPodium(top3);
                renderList(others);
                
                loading.classList.add('hidden'); 
                content.classList.remove('hidden');
            } else {
                loading.innerHTML = `
                    <div class="py-10">
                        <i class="fa-solid fa-ghost text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                        <p class="text-sm">æš‚æ— æ’­æ”¾è®°å½•</p>
                    </div>`;
            }
        } catch (e) { 
            console.error(e); 
            loading.innerText = "æ•°æ®åŠ è½½å¼‚å¸¸"; 
        }
    }

    function renderPodium(items) {
        const container = document.getElementById('podium-section');
        let html = '';
        
        items.forEach(item => {
            // ğŸ”¥ å›¾ç‰‡ URL åŠ ä¸Š v=4 å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼Œæ˜¾ç¤ºç«–å±æµ·æŠ¥
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary?v=4`;
            
            // æ ·å¼é€»è¾‘
            const isFirst = item.rank === 1;
            
            // æ‰‹æœºç«¯é«˜åº¦é€‚é…ï¼šç¡®ä¿ä¸€è¡Œæ”¾ä¸‹3ä¸ª
            // å† å†›ï¼šå®½36%ï¼Œé«˜çº¦190px (mobile) / å®½64 é«˜80 (pc)
            // äºšå­£ï¼šå®½30%ï¼Œé«˜çº¦140px (mobile) / å®½48 é«˜60 (pc)
            let widthClass = isFirst ? 'w-[36%] md:w-64' : 'w-[30%] md:w-48';
            let heightClass = isFirst ? 'aspect-[2/3] md:h-80' : 'aspect-[2/3] md:h-60'; 
            let borderClass = `rank-${item.rank}-border`;
            
            // çš‡å† 
            let crownHtml = isFirst ? '<i class="fa-solid fa-crown crown-icon"></i>' : '';
            
            // æ’åå¾½ç« é¢œè‰²
            let rankBadgeColor = isFirst ? 'bg-gradient-to-r from-yellow-400 to-yellow-600' : (item.rank === 2 ? 'bg-gray-400' : 'bg-amber-700');
            
            // ğŸ”¥ æ ¸å¿ƒå¸ƒå±€é€»è¾‘ï¼šåˆ©ç”¨ order å±æ€§è°ƒæ•´è§†è§‰é¡ºåº
            // Rank 2 (äºšå†›) -> order-1 (å·¦è¾¹)
            // Rank 1 (å† å†›) -> order-2 (ä¸­é—´)
            // Rank 3 (å­£å†›) -> order-3 (å³è¾¹)
            let orderClass = '';
            if (item.rank === 1) orderClass = 'order-2 z-10 -mx-1 mb-1'; 
            if (item.rank === 2) orderClass = 'order-1';       
            if (item.rank === 3) orderClass = 'order-3';       

            html += `
            <div class="podium-card relative flex flex-col items-center group shrink-0 ${orderClass} ${widthClass}">
                ${crownHtml}
                <div class="relative w-full rounded-xl md:rounded-2xl overflow-hidden border-2 md:border-4 ${borderClass} ${heightClass} bg-gray-200 dark:bg-gray-800 shadow-lg">
                    <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700" 
                         loading="lazy"
                         onerror="this.src='https://via.placeholder.com/300x450?text=No+Cover'">
                    
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent"></div>
                    
                    <div class="absolute bottom-0 left-0 right-0 p-2 md:p-3 text-center">
                        <div class="inline-block ${rankBadgeColor} text-white text-[10px] md:text-xs font-bold px-1.5 md:px-2 py-0.5 rounded shadow-sm mb-1">
                            #${item.rank}
                        </div>
                        <h3 class="text-white font-bold text-xs md:text-lg line-clamp-1 leading-tight drop-shadow-sm">${item.ItemName}</h3>
                        <p class="text-gray-300 text-[10px] md:text-xs mt-0.5 font-mono opacity-90">${item.PlayCount} æ¬¡</p>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    function renderList(items) {
        const container = document.getElementById('list-section');
        if(items.length === 0) { 
            container.innerHTML = '<div class="p-8 text-center text-gray-400 text-xs">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</div>'; 
            return; 
        }

        let html = '';
        items.forEach((item, index) => {
            const rank = index + 4;
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary?v=4`;
            
            html += `
            <div class="flex items-center p-3 md:p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition group cursor-default">
                <div class="w-6 md:w-8 text-center font-bold text-gray-300 dark:text-gray-600 text-sm md:text-lg mr-2 md:mr-4 italic">
                    ${rank}
                </div>
                <div class="w-10 h-14 md:w-12 md:h-16 rounded-md bg-gray-200 dark:bg-gray-700 overflow-hidden shrink-0 mr-3 shadow-sm relative">
                     <img src="${imgUrl}" class="w-full h-full object-cover" loading="lazy">
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-xs md:text-sm font-bold text-gray-800 dark:text-gray-200 truncate group-hover:text-amber-600 transition">
                        ${item.ItemName}
                    </h4>
                    <div class="text-[10px] md:text-xs text-gray-400 mt-1 flex items-center gap-2">
                        <span class="bg-gray-100 dark:bg-gray-700 px-1.5 py-0.5 rounded text-gray-500 dark:text-gray-400">
                            <i class="fa-solid fa-play text-[8px] mr-1"></i>${item.PlayCount}
                        </span>
                        <span>
                            <i class="fa-regular fa-clock mr-1"></i>${Math.round(item.TotalTime/60)}m
                        </span>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    init();
</script>
{% endblock %}