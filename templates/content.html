{% extends "layout.html" %}

{% block title %}å†…å®¹é£äº‘æ¦œ - EmbyPulse{% endblock %}

{% block head %}
<style>
    .hero-mask { 
        background: linear-gradient(to right, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.8) 40%, rgba(255,255,255,0) 100%); 
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full px-8 py-8">
    <div class="flex justify-between items-end mb-6">
        <h1 class="text-2xl font-black text-gray-900">å†…å®¹é£äº‘æ¦œ</h1>
        <button onclick="loadContent()" class="text-sm text-gray-500 hover:text-green-600">
            <i class="fa-solid fa-rotate-right mr-1"></i> åˆ·æ–°
        </button>
    </div>

    <div id="loading" class="text-center py-20 text-gray-400">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl"></i>
        <p class="mt-4 text-sm">æ­£åœ¨åˆ†æå…¨æœæ•°æ®...</p>
    </div>

    <div id="content-area" class="hidden animate-fade-in">
        
        <div id="hero-section"></div>

        <h3 class="text-xl font-bold text-gray-900 mb-4 mt-10">
            <i class="fa-solid fa-list-ol text-gray-400 mr-2"></i> çƒ­é—¨æ¦œå• Top 10
        </h3>
        <div id="list-section" class="grid grid-cols-1 gap-4"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadContent() {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content-area').classList.add('hidden');

        try {
            const response = await fetch('/api/stats/top_movies');
            const res = await response.json();
            
            if(res.status === 'success' && res.data.length > 0) {
                const list = res.data;
                const top1 = list[0];
                const others = list.slice(1);
                
                renderHero(top1);
                renderList(others);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');
            } else {
                document.getElementById('loading').innerHTML = "<p>æš‚æ— æ’­æ”¾æ•°æ®</p>";
            }
        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerText = "æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥åå°æ—¥å¿—";
        }
    }

    // æ¸²æŸ“ Top 1
    function renderHero(item) {
        // ğŸ”¥ ä½¿ç”¨åç«¯ä»£ç†æ¥å£è·å–å›¾ç‰‡
        const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
        const bgUrl = `/api/proxy/image/${item.ItemId}/backdrop`;
        
        const html = `
        <div class="relative w-full h-80 rounded-3xl overflow-hidden shadow-xl mb-8 bg-gray-900 group">
            <div class="absolute inset-0 bg-cover bg-center opacity-60 transition duration-700 group-hover:scale-105" 
                 style="background-image: url('${bgUrl}');"></div>
            <div class="absolute inset-0 hero-mask"></div>
            
            <div class="relative z-10 h-full flex items-center px-10">
                <div class="w-40 h-60 rounded-xl shadow-2xl overflow-hidden border-4 border-white transform rotate-3 transition group-hover:rotate-0 bg-gray-300 shrink-0">
                    <img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x450?text=No+Img'">
                </div>
                <div class="ml-8 max-w-lg">
                    <div class="text-yellow-600 font-bold uppercase tracking-wider text-sm mb-1">
                        <i class="fa-solid fa-crown"></i> å…¨æœå† å†›
                    </div>
                    <h2 class="text-4xl font-black text-gray-900 leading-tight mb-4 line-clamp-2">${item.ItemName}</h2>
                    <div class="flex space-x-8 text-gray-700">
                        <div>
                            <span class="text-3xl font-bold block">${item.PlayCount}</span>
                            <span class="text-xs text-gray-500 uppercase">æ’­æ”¾æ¬¡æ•°</span>
                        </div>
                        <div>
                            <span class="text-3xl font-bold block">${Math.round(item.TotalTime/60)}</span>
                            <span class="text-xs text-gray-500 uppercase">ç´¯è®¡åˆ†é’Ÿ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        document.getElementById('hero-section').innerHTML = html;
    }

    // æ¸²æŸ“åˆ—è¡¨
    function renderList(items) {
        let html = '';
        items.forEach((item, index) => {
            const rank = index + 2;
            // ğŸ”¥ ä½¿ç”¨åç«¯ä»£ç†æ¥å£è·å–å›¾ç‰‡
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            
            let rankColor = "text-gray-300";
            if(rank === 2) rankColor = "text-gray-400";
            if(rank === 3) rankColor = "text-amber-700";

            html += `
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex items-center hover:shadow-md transition group">
                <div class="w-12 text-center mr-4 text-3xl font-black ${rankColor} italic">${rank}</div>
                <div class="w-12 h-16 rounded bg-gray-200 overflow-hidden shrink-0 mr-4 shadow-sm">
                     <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500" onerror="this.src='https://via.placeholder.com/100x150?text=No'">
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-base font-bold text-gray-800 truncate">${item.ItemName}</h4>
                    <div class="text-xs text-gray-500 mt-1">
                        <span class="bg-gray-100 px-2 py-0.5 rounded text-gray-600">æ’­æ”¾ ${item.PlayCount} æ¬¡</span>
                    </div>
                </div>
                <div class="text-right px-4 hidden sm:block">
                     <div class="text-sm font-bold text-gray-700">${Math.round(item.TotalTime/60)}m</div>
                     <div class="text-xs text-gray-400">æ—¶é•¿</div>
                </div>
            </div>`;
        });
        document.getElementById('list-section').innerHTML = html;
    }

    // é¡µé¢åŠ è½½å³è¿è¡Œ
    loadContent();
</script>
{% endblock %}
