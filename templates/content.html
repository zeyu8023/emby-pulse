{% extends "layout.html" %}

{% block title %}å†…å®¹é£äº‘æ¦œ - EmbyPulse{% endblock %}

{% block head %}
<style>
    .hero-mask { 
        background: linear-gradient(to right, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.8) 40%, rgba(255,255,255,0) 100%); 
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full px-8 py-8">
    <div class="flex flex-col md:flex-row justify-between items-end md:items-center mb-8 gap-4">
        <div>
            <h1 class="text-2xl font-black text-gray-900">å†…å®¹é£äº‘æ¦œ</h1>
            <p class="text-xs text-gray-500 mt-1">æŸ¥çœ‹å¤§å®¶éƒ½åœ¨çœ‹ä»€ä¹ˆ</p>
        </div>
        
        <div class="flex items-center gap-3">
            <div class="relative">
                <select id="user-select" onchange="changeUser()" class="appearance-none bg-white border border-gray-200 text-gray-700 py-2 pl-4 pr-10 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm font-medium">
                    <option value="all">ğŸŒ å…¨æœæ•°æ®</option>
                    </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
                    <i class="fa-solid fa-chevron-down text-xs"></i>
                </div>
            </div>

            <button onclick="refreshCurrent()" class="bg-white border border-gray-200 text-gray-500 hover:text-green-600 w-9 h-9 rounded-lg shadow-sm flex items-center justify-center transition">
                <i class="fa-solid fa-rotate-right"></i>
            </button>
        </div>
    </div>

    <div id="loading" class="text-center py-20 text-gray-400">
        <i class="fa-solid fa-circle-notch fa-spin text-3xl"></i>
        <p class="mt-4 text-sm">æ­£åœ¨åˆ†ææ•°æ®...</p>
    </div>

    <div id="content-area" class="hidden animate-fade-in">
        <div id="hero-section"></div>
        <h3 class="text-xl font-bold text-gray-900 mb-4 mt-10 flex items-center">
            <i class="fa-solid fa-fire text-red-500 mr-2"></i> çƒ­é—¨æ¦œå• Top 10
        </h3>
        <div id="list-section" class="grid grid-cols-1 gap-4"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = 'all';

    // åˆå§‹åŒ–
    async function init() {
        await loadUsers();
        loadContent('all');
    }

    // 1. åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const json = await res.json();
            if(json.status === 'success') {
                const select = document.getElementById('user-select');
                json.data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.UserId;
                    option.innerText = `ğŸ‘¤ ${user.UserName}`;
                    select.appendChild(option);
                });
            }
        } catch (e) { console.error("Load users failed", e); }
    }

    // 2. åˆ‡æ¢ç”¨æˆ·
    function changeUser() {
        currentUser = document.getElementById('user-select').value;
        loadContent(currentUser);
    }

    // 3. åˆ·æ–°å½“å‰
    function refreshCurrent() {
        loadContent(currentUser);
    }

    // 4. åŠ è½½å†…å®¹ (å¸¦ user_id å‚æ•°)
    async function loadContent(userId) {
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content-area').classList.add('hidden');

        try {
            // æ‹¼æ¥ URL å‚æ•°
            const url = `/api/stats/top_movies?user_id=${userId}`;
            const response = await fetch(url);
            const res = await response.json();
            
            if(res.status === 'success' && res.data.length > 0) {
                const list = res.data;
                renderHero(list[0]);
                renderList(list.slice(1));
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('content-area').classList.remove('hidden');
            } else {
                document.getElementById('loading').innerHTML = `
                    <div class="py-10">
                        <i class="fa-solid fa-ghost text-4xl text-gray-200 mb-4"></i>
                        <p>è¯¥ç”¨æˆ·æš‚æ— æ’­æ”¾è®°å½•</p>
                    </div>`;
            }
        } catch (e) {
            console.error(e);
            document.getElementById('loading').innerText = "æ•°æ®åŠ è½½å¤±è´¥";
        }
    }

    // æ¸²æŸ“å‡½æ•° (ä¿æŒä¹‹å‰çš„é€»è¾‘ï¼Œåªæ˜¯æ¥å£å˜èªæ˜äº†)
    function renderHero(item) {
        const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
        const bgUrl = `/api/proxy/image/${item.ItemId}/backdrop`;
        
        const html = `
        <div class="relative w-full h-80 rounded-3xl overflow-hidden shadow-xl mb-8 bg-gray-900 group">
            <div class="absolute inset-0 bg-cover bg-center opacity-60 transition duration-1000 group-hover:scale-105" 
                 style="background-image: url('${bgUrl}');"></div>
            <div class="absolute inset-0 hero-mask"></div>
            <div class="relative z-10 h-full flex items-center px-6 md:px-10">
                <div class="w-32 h-48 md:w-40 md:h-60 rounded-xl shadow-2xl overflow-hidden border-4 border-white transform rotate-3 transition group-hover:rotate-0 bg-gray-800 shrink-0">
                    <img src="${imgUrl}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/300x450?text=No+Img'">
                </div>
                <div class="ml-6 md:ml-8 max-w-lg">
                    <div class="text-yellow-600 font-bold uppercase tracking-wider text-xs md:text-sm mb-1">
                        <i class="fa-solid fa-crown"></i> æ’­æ”¾å† å†›
                    </div>
                    <h2 class="text-2xl md:text-4xl font-black text-gray-900 leading-tight mb-2 md:mb-4 line-clamp-2">${item.ItemName}</h2>
                    <div class="flex space-x-6 text-gray-700">
                        <div>
                            <span class="text-xl md:text-3xl font-bold block">${item.PlayCount}</span>
                            <span class="text-xs text-gray-500 uppercase">æ¬¡æ’­æ”¾</span>
                        </div>
                        <div>
                            <span class="text-xl md:text-3xl font-bold block">${Math.round(item.TotalTime/60)}</span>
                            <span class="text-xs text-gray-500 uppercase">åˆ†é’Ÿ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        document.getElementById('hero-section').innerHTML = html;
    }

    function renderList(items) {
        let html = '';
        items.forEach((item, index) => {
            const rank = index + 2;
            const imgUrl = `/api/proxy/image/${item.ItemId}/primary`;
            
            let rankStyle = "text-gray-300";
            if(rank === 2) rankStyle = "text-gray-400";
            if(rank === 3) rankStyle = "text-amber-700";

            html += `
            <div class="bg-white rounded-xl p-3 md:p-4 shadow-sm border border-gray-100 flex items-center hover:shadow-md transition group">
                <div class="w-8 md:w-12 text-center mr-3 md:mr-4 text-2xl md:text-3xl font-black ${rankStyle} italic">${rank}</div>
                <div class="w-10 h-14 md:w-12 md:h-16 rounded bg-gray-200 overflow-hidden shrink-0 mr-4 shadow-sm relative">
                     <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm md:text-base font-bold text-gray-800 truncate">${item.ItemName}</h4>
                    <div class="text-xs text-gray-500 mt-0.5">æ’­æ”¾ ${item.PlayCount} æ¬¡</div>
                </div>
                <div class="text-right px-2 hidden sm:block">
                     <div class="text-sm font-bold text-gray-700">${Math.round(item.TotalTime/60)}m</div>
                </div>
            </div>`;
        });
        document.getElementById('list-section').innerHTML = html;
    }

    init();
</script>
{% endblock %}
