{% extends "layout.html" %}
{% block title %}åª’ä½“åº“è´¨é‡ç›˜ç‚¹ - EmbyPulse{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto w-full px-4 py-6 pb-24">
    
    <div class="mb-8">
        <h1 class="text-2xl font-black text-gray-800 dark:text-white flex items-center gap-2">
            <i class="fa-solid fa-medal text-yellow-500"></i> åª’ä½“åº“è´¨é‡ç›˜ç‚¹
        </h1>
        <p class="text-xs text-gray-500 mt-1">æ·±åº¦æ‰«æç”µå½±åº“ï¼Œåˆ†æç”»è´¨ä¸ç¼–ç åˆ†å¸ƒ</p>
    </div>

    <div id="loading" class="text-center py-32">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-gray-500">æ­£åœ¨åˆ†æåª’ä½“æŒ‡çº¹ï¼Œå¯èƒ½éœ€è¦å‡ åç§’...</p>
    </div>

    <div id="stats-panel" class="hidden animate-fade-in space-y-6">
        
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="text-xs text-gray-400 mb-1">ç”µå½±æ€»æ•°</div>
                <div class="text-2xl font-black text-gray-800 dark:text-white" id="val-total">-</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="text-xs text-gray-400 mb-1">4K åŸç›˜/Remux</div>
                <div class="text-2xl font-black text-purple-600" id="val-4k">-</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="text-xs text-gray-400 mb-1">æœæ¯”/HDR</div>
                <div class="text-2xl font-black text-amber-500" id="val-hdr">-</div>
            </div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <div class="text-xs text-gray-400 mb-1">HEVC ç¼–ç ç‡</div>
                <div class="text-2xl font-black text-green-500" id="val-hevc">-</div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4">ğŸ“º åˆ†è¾¨ç‡åˆ†å¸ƒ</h3>
                <div id="chart-res" style="height: 300px; width: 100%;"></div>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
                <h3 class="font-bold text-gray-700 dark:text-gray-200 mb-4">ğŸŒˆ åŠ¨æ€èŒƒå›´ (HDR)</h3>
                <div id="chart-hdr" style="height: 300px; width: 100%;"></div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 bg-red-50 dark:bg-red-900/20 flex justify-between items-center">
                <h3 class="font-bold text-red-600 dark:text-red-400 text-sm">
                    <i class="fa-solid fa-trash-can mr-2"></i> ä½ç”»è´¨æ¸…æ´—å»ºè®® (SD/480P)
                </h3>
                <span class="text-xs text-red-400">å»ºè®®æ´—ç‰ˆ</span>
            </div>
            <div id="low-quality-list" class="divide-y divide-gray-50 dark:divide-gray-700/50">
                </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
        try {
            const res = await fetch('/api/insight/quality');
            const json = await res.json();
            
            if (json.status === 'success') {
                // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šå…ˆæ˜¾ç¤ºé¢æ¿ï¼Œå†æ¸²æŸ“å›¾è¡¨ï¼
                // ECharts å¦‚æœåœ¨ hidden å®¹å™¨é‡Œåˆå§‹åŒ–ï¼Œå®½é«˜ä¼šæ˜¯ 0
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('stats-panel').classList.remove('hidden');
                
                // ç»™ä¸€ç‚¹å¾®å°çš„å»¶è¿Ÿç¡®ä¿ DOM æ¸²æŸ“å®Œæˆ
                setTimeout(() => {
                    renderDashboard(json.data);
                }, 50);
            } else {
                alert("åŠ è½½å¤±è´¥: " + json.msg);
            }
        } catch (e) {
            console.error(e);
            alert("è¯·æ±‚å¼‚å¸¸");
        }
    }

    function renderDashboard(data) {
        // 1. å¡«å……æ•°å­—
        document.getElementById('val-total').innerText = data.total;
        document.getElementById('val-4k').innerText = data.resolution['4K'];
        document.getElementById('val-hdr').innerText = data.hdr['Dolby Vision'] + data.hdr['HDR10'];
        
        const hevcRate = data.total > 0 ? ((data.codec['HEVC (H.265)'] / data.total) * 100).toFixed(0) : 0;
        document.getElementById('val-hevc').innerText = hevcRate + '%';

        // 2. ç»˜åˆ¶åˆ†è¾¨ç‡é¥¼å›¾
        const resDom = document.getElementById('chart-res');
        const chartRes = echarts.init(resDom);
        chartRes.setOption({
            tooltip: { trigger: 'item' },
            legend: { bottom: '0%', left: 'center' },
            series: [{
                name: 'åˆ†è¾¨ç‡',
                type: 'pie',
                radius: ['40%', '70%'],
                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                data: [
                    { value: data.resolution['4K'], name: '4K', itemStyle: { color: '#8b5cf6' } },
                    { value: data.resolution['1080P'], name: '1080P', itemStyle: { color: '#3b82f6' } },
                    { value: data.resolution['720P'], name: '720P', itemStyle: { color: '#10b981' } },
                    { value: data.resolution['SD'], name: 'SD (ä½ç”»è´¨)', itemStyle: { color: '#ef4444' } }
                ]
            }]
        });

        // 3. ç»˜åˆ¶ HDR ç¯å½¢å›¾
        const hdrDom = document.getElementById('chart-hdr');
        const chartHdr = echarts.init(hdrDom);
        chartHdr.setOption({
            tooltip: { trigger: 'item' },
            legend: { bottom: '0%', left: 'center' },
            series: [{
                name: 'HDR',
                type: 'pie',
                radius: ['40%', '70%'],
                itemStyle: { borderRadius: 10, borderColor: '#fff', borderWidth: 2 },
                data: [
                    { value: data.hdr['Dolby Vision'], name: 'Dolby Vision', itemStyle: { color: '#f59e0b' } },
                    { value: data.hdr['HDR10'], name: 'HDR10', itemStyle: { color: '#ec4899' } },
                    { value: data.hdr['SDR'], name: 'SDR', itemStyle: { color: '#94a3b8' } }
                ]
            }]
        });

        // 4. å¡«å……ä½ç”»è´¨åˆ—è¡¨
        const listContainer = document.getElementById('low-quality-list');
        if (data.low_quality_list.length === 0) {
            listContainer.innerHTML = '<div class="p-6 text-center text-gray-400 text-sm">ğŸ‰ å®Œç¾ï¼æ²¡æœ‰å‘ç°ä½ç”»è´¨å½±ç‰‡</div>';
        } else {
            let html = '';
            data.low_quality_list.forEach(item => {
                html += `
                <div class="flex items-center justify-between p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded bg-gray-200 flex items-center justify-center text-xl">ğŸ¬</div>
                        <div>
                            <div class="font-bold text-gray-800 dark:text-gray-200 text-sm">${item.Name}</div>
                            <div class="text-xs text-gray-500">${item.Year}</div>
                        </div>
                    </div>
                    <div class="text-xs font-mono bg-red-100 text-red-600 px-2 py-1 rounded">
                        ${item.Res}
                    </div>
                </div>`;
            });
            listContainer.innerHTML = html;
        }
        
        // çª—å£ç¼©æ”¾è‡ªé€‚åº”
        window.addEventListener('resize', () => {
            chartRes.resize();
            chartHdr.resize();
        });
    }
</script>
{% endblock %}